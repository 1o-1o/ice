/**
Copyright (c) The New York Times, CMS Group, Matthew DeLambo

This program is free software; you can redistribute it and/or modify
it under the terms of the GNU General Public License, version 2, as
published by the Free Software Foundation.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program as the file license.txt. If not, see
<http://www.gnu.org/licenses/old-licenses/gpl-2.0.txt>

**/
window.rangy=function(){function c(a,b){var d=typeof a[b];return d==n||!!(d==j&&a[b])||d=="unknown"}function b(a,b){return!!(typeof a[b]==j&&a[b])}function a(a,b){return typeof a[b]!=l}function d(a){return function(b,d){for(var c=d.length;c--;)if(!a(b,d[c]))return!1;return!0}}function e(a){return a&&k(a,q)&&x(a,i)}function f(a){window.alert("Rangy not supported in your browser. Reason: "+a);r.initialized=!0;r.supported=!1}function g(){if(!r.initialized){var a,d=!1,p=!1;c(document,"createRange")&&
(a=document.createRange(),k(a,o)&&x(a,s)&&(d=!0),a.detach());if((a=b(document,"body")?document.body:document.getElementsByTagName("body")[0])&&c(a,"createTextRange"))a=a.createTextRange(),e(a)&&(p=!0);!d&&!p&&f("Neither Range nor TextRange are implemented");r.initialized=!0;r.features={implementsDomRange:d,implementsTextRange:p};d=E.concat(w);p=0;for(a=d.length;p<a;++p)try{d[p](r)}catch(j){b(window,"console")&&c(window.console,"log")&&window.console.log("Init listener threw an exception. Continuing.",
j)}}}function h(a){this.name=a;this.supported=this.initialized=!1}var j="object",n="function",l="undefined",s=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer","START_TO_START","START_TO_END","END_TO_START","END_TO_END"],o=["setStart","setStartBefore","setStartAfter","setEnd","setEndBefore","setEndAfter","collapse","selectNode","selectNodeContents","compareBoundaryPoints","deleteContents","extractContents","cloneContents","insertNode","surroundContents",
"cloneRange","toString","detach"],i=["boundingHeight","boundingLeft","boundingTop","boundingWidth","htmlText","text"],q=["collapse","compareEndPoints","duplicate","getBookmark","moveToBookmark","moveToElementText","parentElement","pasteHTML","select","setEndPoint","getBoundingClientRect"],k=d(c),p=d(b),x=d(a),r={version:"1.2",initialized:!1,supported:!0,util:{isHostMethod:c,isHostObject:b,isHostProperty:a,areHostMethods:k,areHostObjects:p,areHostProperties:x,isTextRange:e},features:{},modules:{},
config:{alertOnWarn:!1,preferTextRange:!1}};r.fail=f;r.warn=function(a){a="Rangy warning: "+a;r.config.alertOnWarn?window.alert(a):typeof window.console!=l&&typeof window.console.log!=l&&window.console.log(a)};({}).hasOwnProperty?r.util.extend=function(a,b){for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d])}:f("hasOwnProperty not supported");var w=[],E=[];r.init=g;r.addInitListener=function(a){r.initialized?a(r):w.push(a)};var A=[];r.addCreateMissingNativeApiListener=function(a){A.push(a)};r.createMissingNativeApi=
function(a){a=a||window;g();for(var b=0,d=A.length;b<d;++b)A[b](a)};h.prototype.fail=function(a){this.initialized=!0;this.supported=!1;throw Error("Module '"+this.name+"' failed to load: "+a);};h.prototype.warn=function(a){r.warn("Module "+this.name+": "+a)};h.prototype.createError=function(a){return Error("Error in Rangy "+this.name+" module: "+a)};r.createModule=function(a,b){var d=new h(a);r.modules[a]=d;E.push(function(a){b(a,d);d.initialized=!0;d.supported=!0})};r.requireModules=function(a){for(var b=
0,d=a.length,c,e;b<d;++b){e=a[b];c=r.modules[e];if(!c||!(c instanceof h))throw Error("Module '"+e+"' not found");if(!c.supported)throw Error("Module '"+e+"' not supported");}};var z=!1,p=function(){z||(z=!0,r.initialized||g())};if(typeof window==l)f("No window found");else if(typeof document==l)f("No document found");else return c(document,"addEventListener")&&document.addEventListener("DOMContentLoaded",p,!1),c(window,"addEventListener")?window.addEventListener("load",p,!1):c(window,"attachEvent")?
window.attachEvent("onload",p):f("Window does not have required addEventListener or attachEvent method"),r}();
rangy.createModule("DomUtil",function(c,b){function a(a){for(var b=0;a=a.previousSibling;)b++;return b}function d(a,b){var d=[],c;for(c=a;c;c=c.parentNode)d.push(c);for(c=b;c;c=c.parentNode)if(k(d,c))return c;return null}function e(a,b,d){for(d=d?a:a.parentNode;d;){a=d.parentNode;if(a===b)return d;d=a}return null}function f(a){a=a.nodeType;return a==3||a==4||a==8}function g(a,b){var d=b.nextSibling,c=b.parentNode;d?c.insertBefore(a,d):c.appendChild(a);return a}function h(a){if(a.nodeType==9)return a;
else if(typeof a.ownerDocument!=o)return a.ownerDocument;else if(typeof a.document!=o)return a.document;else if(a.parentNode)return h(a.parentNode);else throw Error("getDocument: no document found for node");}function j(a){return!a?"[No node]":f(a)?'"'+a.data+'"':a.nodeType==1?"<"+a.nodeName+(a.id?' id="'+a.id+'"':"")+">["+a.childNodes.length+"]":a.nodeName}function n(a){this._next=this.root=a}function l(a,b){this.node=a;this.offset=b}function s(a){this.code=this[a];this.codeName=a;this.message="DOMException: "+
this.codeName}var o="undefined",i=c.util;i.areHostMethods(document,["createDocumentFragment","createElement","createTextNode"])||b.fail("document missing a Node creation method");i.isHostMethod(document,"getElementsByTagName")||b.fail("document missing getElementsByTagName method");var q=document.createElement("div");i.areHostMethods(q,["insertBefore","appendChild","cloneNode"])||b.fail("Incomplete Element implementation");q=document.createTextNode("test");i.areHostMethods(q,["splitText","deleteData",
"insertData","appendData","cloneNode"])||b.fail("Incomplete Text Node implementation");var k=function(a,b){for(var d=a.length;d--;)if(a[d]===b)return!0;return!1};n.prototype={_current:null,hasNext:function(){return!!this._next},next:function(){var a=this._current=this._next,b;if(this._current){b=a.firstChild;if(!b)for(b=null;a!==this.root&&!(b=a.nextSibling);)a=a.parentNode;this._next=b}return this._current},detach:function(){this._current=this._next=this.root=null}};l.prototype={equals:function(a){return this.node===
a.node&this.offset==a.offset},inspect:function(){return"[DomPosition("+j(this.node)+":"+this.offset+")]"}};s.prototype={INDEX_SIZE_ERR:1,HIERARCHY_REQUEST_ERR:3,WRONG_DOCUMENT_ERR:4,NO_MODIFICATION_ALLOWED_ERR:7,NOT_FOUND_ERR:8,NOT_SUPPORTED_ERR:9,INVALID_STATE_ERR:11};s.prototype.toString=function(){return this.message};c.dom={arrayContains:k,getNodeIndex:a,getNodeLength:function(a){var b;return f(a)?a.length:(b=a.childNodes)?b.length:0},getCommonAncestor:d,isAncestorOf:function(a,b,d){for(b=d?b:
b.parentNode;b;)if(b===a)return!0;else b=b.parentNode;return!1},getClosestAncestorIn:e,isCharacterDataNode:f,insertAfter:g,splitDataNode:function(a,b){var d=a.cloneNode(!1);d.deleteData(0,b);a.deleteData(b,a.length-b);g(d,a);return d},getDocument:h,getWindow:function(a){a=h(a);if(typeof a.defaultView!=o)return a.defaultView;else if(typeof a.parentWindow!=o)return a.parentWindow;else throw Error("Cannot get a window object for node");},getIframeWindow:function(a){if(typeof a.contentWindow!=o)return a.contentWindow;
else if(typeof a.contentDocument!=o)return a.contentDocument.defaultView;else throw Error("getIframeWindow: No Window object found for iframe element");},getIframeDocument:function(a){if(typeof a.contentDocument!=o)return a.contentDocument;else if(typeof a.contentWindow!=o)return a.contentWindow.document;else throw Error("getIframeWindow: No Document object found for iframe element");},getBody:function(a){return i.isHostObject(a,"body")?a.body:a.getElementsByTagName("body")[0]},getRootContainer:function(a){for(var b;b=
a.parentNode;)a=b;return a},comparePoints:function(b,c,f,k){var j;if(b==f)return c===k?0:c<k?-1:1;else if(j=e(f,b,!0))return c<=a(j)?-1:1;else if(j=e(b,f,!0))return a(j)<k?-1:1;else if(c=d(b,f),b=b===c?c:e(b,c,!0),f=f===c?c:e(f,c,!0),b===f)throw Error("comparePoints got to case 4 and childA and childB are the same!");else{for(c=c.firstChild;c;){if(c===b)return-1;else if(c===f)return 1;c=c.nextSibling}throw Error("Should not be here!");}},inspectNode:j,createIterator:function(a){return new n(a)},DomPosition:l};
c.DOMException=s});
rangy.createModule("DomRange",function(c){function b(a,b){return a.nodeType!=3&&(m.isAncestorOf(a,b.startContainer,!0)||m.isAncestorOf(a,b.endContainer,!0))}function a(a){return m.getDocument(a.startContainer)}function d(a,b,d){if(b=a._listeners[b])for(var c=0,e=b.length;c<e;++c)b[c].call(a,{target:a,args:d})}function e(a){return new u(a.parentNode,m.getNodeIndex(a))}function f(a){return new u(a.parentNode,m.getNodeIndex(a)+1)}function g(a,b,d){var c=a.nodeType==11?a.firstChild:a;m.isCharacterDataNode(b)?
d==b.length?m.insertAfter(a,b):b.parentNode.insertBefore(a,d==0?b:m.splitDataNode(b,d)):d>=b.childNodes.length?b.appendChild(a):b.insertBefore(a,b.childNodes[d]);return c}function h(b){for(var d,c,e=a(b.range).createDocumentFragment();c=b.next();){d=b.isPartiallySelectedSubtree();c=c.cloneNode(!d);d&&(d=b.getSubtreeIterator(),c.appendChild(h(d)),d.detach(!0));if(c.nodeType==10)throw new B("HIERARCHY_REQUEST_ERR");e.appendChild(c)}return e}function j(a,b,d){for(var c,e,d=d||{stop:!1};c=a.next();)if(a.isPartiallySelectedSubtree())if(b(c)===
!1){d.stop=!0;break}else{if(c=a.getSubtreeIterator(),j(c,b,d),c.detach(!0),d.stop)break}else for(c=m.createIterator(c);e=c.next();)if(b(e)===!1){d.stop=!0;return}}function n(a){for(var b;a.next();)a.isPartiallySelectedSubtree()?(b=a.getSubtreeIterator(),n(b),b.detach(!0)):a.remove()}function l(b){for(var d,c=a(b.range).createDocumentFragment(),e;d=b.next();){b.isPartiallySelectedSubtree()?(d=d.cloneNode(!1),e=b.getSubtreeIterator(),d.appendChild(l(e)),e.detach(!0)):b.remove();if(d.nodeType==10)throw new B("HIERARCHY_REQUEST_ERR");
c.appendChild(d)}return c}function s(a,b,d){var c=!(!b||!b.length),e,t=!!d;c&&(e=RegExp("^("+b.join("|")+")$"));var f=[];j(new i(a,!1),function(a){(!c||e.test(a.nodeType))&&(!t||d(a))&&f.push(a)});return f}function o(a){return"["+(typeof a.getName=="undefined"?"Range":a.getName())+"("+m.inspectNode(a.startContainer)+":"+a.startOffset+", "+m.inspectNode(a.endContainer)+":"+a.endOffset+")]"}function i(a,b){this.range=a;this.clonePartiallySelectedTextNodes=b;if(!a.collapsed){this.sc=a.startContainer;
this.so=a.startOffset;this.ec=a.endContainer;this.eo=a.endOffset;var d=a.commonAncestorContainer;this.sc===this.ec&&m.isCharacterDataNode(this.sc)?(this.isSingleCharacterDataNode=!0,this._first=this._last=this._next=this.sc):(this._first=this._next=this.sc===d&&!m.isCharacterDataNode(this.sc)?this.sc.childNodes[this.so]:m.getClosestAncestorIn(this.sc,d,!0),this._last=this.ec===d&&!m.isCharacterDataNode(this.ec)?this.ec.childNodes[this.eo-1]:m.getClosestAncestorIn(this.ec,d,!0))}}function q(a){this.code=
this[a];this.codeName=a;this.message="RangeException: "+this.codeName}function k(a,b,d){this.nodes=s(a,b,d);this._next=this.nodes[0];this._position=0}function p(a){return function(b,d){for(var c,e=d?b:b.parentNode;e;){c=e.nodeType;if(m.arrayContains(a,c))return e;e=e.parentNode}return null}}function x(a,b){if(Y(a,b))throw new q("INVALID_NODE_TYPE_ERR");}function r(a){if(!a.startContainer)throw new B("INVALID_STATE_ERR");}function w(a,b){if(!m.arrayContains(b,a.nodeType))throw new q("INVALID_NODE_TYPE_ERR");
}function E(a,b){if(b<0||b>(m.isCharacterDataNode(a)?a.length:a.childNodes.length))throw new B("INDEX_SIZE_ERR");}function A(a,b){if(L(a,!0)!==L(b,!0))throw new B("WRONG_DOCUMENT_ERR");}function z(a){if(Z(a,!0))throw new B("NO_MODIFICATION_ALLOWED_ERR");}function y(a,b){if(!a)throw new B(b);}function v(a){r(a);if(!m.arrayContains(I,a.startContainer.nodeType)&&!L(a.startContainer,!0)||!m.arrayContains(I,a.endContainer.nodeType)&&!L(a.endContainer,!0)||!(a.startOffset<=(m.isCharacterDataNode(a.startContainer)?
a.startContainer.length:a.startContainer.childNodes.length))||!(a.endOffset<=(m.isCharacterDataNode(a.endContainer)?a.endContainer.length:a.endContainer.childNodes.length)))throw Error("Range error: Range is no longer valid after DOM mutation ("+a.inspect()+")");}function G(){}function J(a){a.START_TO_START=Q;a.START_TO_END=T;a.END_TO_END=$;a.END_TO_START=U;a.NODE_BEFORE=V;a.NODE_AFTER=W;a.NODE_BEFORE_AND_AFTER=X;a.NODE_INSIDE=R}function H(a){J(a);J(a.prototype)}function F(a,b){return function(){v(this);
var d=this.startContainer,c=this.startOffset,e=this.commonAncestorContainer,t=new i(this,!0);if(d!==e)d=m.getClosestAncestorIn(d,e,!0),c=f(d),d=c.node,c=c.offset;j(t,z);t.reset();e=a(t);t.detach();b(this,d,c,d,c);return e}}function D(a,d,k){function j(a,b){return function(d){r(this);w(d,N);w(t(d),I);d=(a?e:f)(d);(b?D:g)(this,d.node,d.offset)}}function D(a,b,c){var e=a.endContainer,f=a.endOffset;if(b!==a.startContainer||c!==this.startOffset){if(t(b)!=t(e)||m.comparePoints(b,c,e,f)==1)e=b,f=c;d(a,b,
c,e,f)}}function g(a,b,c){var e=a.startContainer,f=a.startOffset;if(b!==a.endContainer||c!==this.endOffset){if(t(b)!=t(e)||m.comparePoints(b,c,e,f)==-1)e=b,f=c;d(a,e,f,b,c)}}function L(a,b,c){(b!==a.startContainer||c!==this.startOffset||b!==a.endContainer||c!==this.endOffset)&&d(a,b,c,b,c)}a.prototype=new G;c.util.extend(a.prototype,{setStart:function(a,b){r(this);x(a,!0);E(a,b);D(this,a,b)},setEnd:function(a,b){r(this);x(a,!0);E(a,b);g(this,a,b)},setStartBefore:j(!0,!0),setStartAfter:j(!1,!0),setEndBefore:j(!0,
!1),setEndAfter:j(!1,!1),collapse:function(a){v(this);a?d(this,this.startContainer,this.startOffset,this.startContainer,this.startOffset):d(this,this.endContainer,this.endOffset,this.endContainer,this.endOffset)},selectNodeContents:function(a){r(this);x(a,!0);d(this,a,0,a,m.getNodeLength(a))},selectNode:function(a){r(this);x(a,!1);w(a,N);var b=e(a),a=f(a);d(this,b.node,b.offset,a.node,a.offset)},extractContents:F(l,d),deleteContents:F(n,d),canSurroundContents:function(){v(this);z(this.startContainer);
z(this.endContainer);var a=new i(this,!0),d=a._first&&b(a._first,this)||a._last&&b(a._last,this);a.detach();return!d},detach:function(){k(this)},splitBoundaries:function(){v(this);var a=this.startContainer,b=this.startOffset,c=this.endContainer,e=this.endOffset,t=a===c;m.isCharacterDataNode(c)&&e>0&&e<c.length&&m.splitDataNode(c,e);m.isCharacterDataNode(a)&&b>0&&b<a.length&&(a=m.splitDataNode(a,b),t?(e-=b,c=a):c==a.parentNode&&e>=m.getNodeIndex(a)&&e++,b=0);d(this,a,b,c,e)},normalizeBoundaries:function(){v(this);
var a=this.startContainer,b=this.startOffset,c=this.endContainer,e=this.endOffset,t=function(a){var b=a.nextSibling;if(b&&b.nodeType==a.nodeType)c=a,e=a.length,a.appendData(b.data),b.parentNode.removeChild(b)},f=function(d){var t=d.previousSibling;if(t&&t.nodeType==d.nodeType){a=d;var f=d.length;b=t.length;d.insertData(0,t.data);t.parentNode.removeChild(t);a==c?(e+=b,c=a):c==d.parentNode&&(t=m.getNodeIndex(d),e==t?(c=d,e=f):e>t&&e--)}},k=!0;m.isCharacterDataNode(c)?c.length==e&&t(c):(e>0&&(k=c.childNodes[e-
1])&&m.isCharacterDataNode(k)&&t(k),k=!this.collapsed);k?m.isCharacterDataNode(a)?b==0&&f(a):b<a.childNodes.length&&(t=a.childNodes[b])&&m.isCharacterDataNode(t)&&f(t):(a=c,b=e);d(this,a,b,c,e)},collapseToPoint:function(a,b){r(this);x(a,!0);E(a,b);L(this,a,b)}});H(a)}function O(a){a.collapsed=a.startContainer===a.endContainer&&a.startOffset===a.endOffset;a.commonAncestorContainer=a.collapsed?a.startContainer:m.getCommonAncestor(a.startContainer,a.endContainer)}function M(a,b,c,e,t){var f=a.startContainer!==
b||a.startOffset!==c,k=a.endContainer!==e||a.endOffset!==t;a.startContainer=b;a.startOffset=c;a.endContainer=e;a.endOffset=t;O(a);d(a,"boundarychange",{startMoved:f,endMoved:k})}function C(a){this.startContainer=a;this.startOffset=0;this.endContainer=a;this.endOffset=0;this._listeners={boundarychange:[],detach:[]};O(this)}c.requireModules(["DomUtil"]);var m=c.dom,u=m.DomPosition,B=c.DOMException;i.prototype={_current:null,_next:null,_first:null,_last:null,isSingleCharacterDataNode:!1,reset:function(){this._current=
null;this._next=this._first},hasNext:function(){return!!this._next},next:function(){var a=this._current=this._next;if(a)this._next=a!==this._last?a.nextSibling:null,m.isCharacterDataNode(a)&&this.clonePartiallySelectedTextNodes&&(a===this.ec&&(a=a.cloneNode(!0)).deleteData(this.eo,a.length-this.eo),this._current===this.sc&&(a=a.cloneNode(!0)).deleteData(0,this.so));return a},remove:function(){var a=this._current,b,d;m.isCharacterDataNode(a)&&(a===this.sc||a===this.ec)?(b=a===this.sc?this.so:0,d=a===
this.ec?this.eo:a.length,b!=d&&a.deleteData(b,d-b)):a.parentNode&&a.parentNode.removeChild(a)},isPartiallySelectedSubtree:function(){return b(this._current,this.range)},getSubtreeIterator:function(){var b;if(this.isSingleCharacterDataNode)b=this.range.cloneRange(),b.collapse();else{b=new C(a(this.range));var d=this._current,c=d,e=0,t=d,f=m.getNodeLength(d);if(m.isAncestorOf(d,this.sc,!0))c=this.sc,e=this.so;if(m.isAncestorOf(d,this.ec,!0))t=this.ec,f=this.eo;M(b,c,e,t,f)}return new i(b,this.clonePartiallySelectedTextNodes)},
detach:function(a){a&&this.range.detach();this.range=this._current=this._next=this._first=this._last=this.sc=this.so=this.ec=this.eo=null}};q.prototype={BAD_BOUNDARYPOINTS_ERR:1,INVALID_NODE_TYPE_ERR:2};q.prototype.toString=function(){return this.message};k.prototype={_current:null,hasNext:function(){return!!this._next},next:function(){this._current=this._next;this._next=this.nodes[++this._position];return this._current},detach:function(){this._current=this._next=this.nodes=null}};var N=[1,3,4,5,
7,8,10],I=[2,9,11],P=[1,3,4,5,7,8,10,11],K=[1,3,4,5,7,8],t=m.getRootContainer,L=p([9,11]),Z=p([5,6,10,12]),Y=p([6,10,12]),S=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer"],Q=0,T=1,$=2,U=3,V=0,W=1,X=2,R=3;G.prototype={attachListener:function(a,b){this._listeners[a].push(b)},compareBoundaryPoints:function(a,b){v(this);A(this.startContainer,b.startContainer);var d=a==U||a==Q?"start":"end",c=a==T||a==Q?"start":"end";return m.comparePoints(this[d+"Container"],
this[d+"Offset"],b[c+"Container"],b[c+"Offset"])},insertNode:function(a){v(this);w(a,P);z(this.startContainer);if(m.isAncestorOf(a,this.startContainer,!0))throw new B("HIERARCHY_REQUEST_ERR");this.setStartBefore(g(a,this.startContainer,this.startOffset))},cloneContents:function(){v(this);var b,d;if(this.collapsed)return a(this).createDocumentFragment();else{if(this.startContainer===this.endContainer&&m.isCharacterDataNode(this.startContainer))return b=this.startContainer.cloneNode(!0),b.data=b.data.slice(this.startOffset,
this.endOffset),d=a(this).createDocumentFragment(),d.appendChild(b),d;else d=new i(this,!0),b=h(d),d.detach();return b}},canSurroundContents:function(){v(this);z(this.startContainer);z(this.endContainer);var a=new i(this,!0),d=a._first&&b(a._first,this)||a._last&&b(a._last,this);a.detach();return!d},surroundContents:function(a){w(a,K);if(!this.canSurroundContents())throw new q("BAD_BOUNDARYPOINTS_ERR");var b=this.extractContents();if(a.hasChildNodes())for(;a.lastChild;)a.removeChild(a.lastChild);
g(a,this.startContainer,this.startOffset);a.appendChild(b);this.selectNode(a)},cloneRange:function(){v(this);for(var b=new C(a(this)),d=S.length,c;d--;)c=S[d],b[c]=this[c];return b},toString:function(){v(this);var a=this.startContainer;if(a===this.endContainer&&m.isCharacterDataNode(a))return a.nodeType==3||a.nodeType==4?a.data.slice(this.startOffset,this.endOffset):"";else{var b=[],a=new i(this,!0);j(a,function(a){(a.nodeType==3||a.nodeType==4)&&b.push(a.data)});a.detach();return b.join("")}},compareNode:function(a){v(this);
var b=a.parentNode,d=m.getNodeIndex(a);if(!b)throw new B("NOT_FOUND_ERR");a=this.comparePoint(b,d);b=this.comparePoint(b,d+1);return a<0?b>0?X:V:b>0?W:R},comparePoint:function(a,b){v(this);y(a,"HIERARCHY_REQUEST_ERR");A(a,this.startContainer);if(m.comparePoints(a,b,this.startContainer,this.startOffset)<0)return-1;else if(m.comparePoints(a,b,this.endContainer,this.endOffset)>0)return 1;return 0},createContextualFragment:function(b){r(this);var d=a(this),c=d.createElement("div");c.innerHTML=b;for(b=
d.createDocumentFragment();d=c.firstChild;)b.appendChild(d);return b},toHtml:function(){v(this);var b=a(this).createElement("div");b.appendChild(this.cloneContents());return b.innerHTML},intersectsNode:function(b,d){v(this);y(b,"NOT_FOUND_ERR");if(m.getDocument(b)!==a(this))return!1;var c=b.parentNode,e=m.getNodeIndex(b);y(c,"NOT_FOUND_ERR");var t=m.comparePoints(c,e,this.endContainer,this.endOffset),c=m.comparePoints(c,e+1,this.startContainer,this.startOffset);return d?t<=0&&c>=0:t<0&&c>0},isPointInRange:function(a,
b){v(this);y(a,"HIERARCHY_REQUEST_ERR");A(a,this.startContainer);return m.comparePoints(a,b,this.startContainer,this.startOffset)>=0&&m.comparePoints(a,b,this.endContainer,this.endOffset)<=0},intersectsRange:function(b,d){v(this);if(a(b)!=a(this))throw new B("WRONG_DOCUMENT_ERR");var c=m.comparePoints(this.startContainer,this.startOffset,b.endContainer,b.endOffset),e=m.comparePoints(this.endContainer,this.endOffset,b.startContainer,b.startOffset);return d?c<=0&&e>=0:c<0&&e>0},intersection:function(a){if(this.intersectsRange(a)){var b=
m.comparePoints(this.startContainer,this.startOffset,a.startContainer,a.startOffset),d=m.comparePoints(this.endContainer,this.endOffset,a.endContainer,a.endOffset),c=this.cloneRange();b==-1&&c.setStart(a.startContainer,a.startOffset);d==1&&c.setEnd(a.endContainer,a.endOffset);return c}return null},union:function(a){if(this.intersectsRange(a,!0)){var b=this.cloneRange();m.comparePoints(a.startContainer,a.startOffset,this.startContainer,this.startOffset)==-1&&b.setStart(a.startContainer,a.startOffset);
m.comparePoints(a.endContainer,a.endOffset,this.endContainer,this.endOffset)==1&&b.setEnd(a.endContainer,a.endOffset);return b}else throw new q("Ranges do not intersect");},containsNode:function(a,b){return b?this.intersectsNode(a,!1):this.compareNode(a)==R},containsNodeContents:function(a){return this.comparePoint(a,0)>=0&&this.comparePoint(a,m.getNodeLength(a))<=0},containsRange:function(a){return this.intersection(a).equals(a)},containsNodeText:function(a){var b=this.cloneRange();b.selectNode(a);
var d=b.getNodes([3]);return d.length>0?(b.setStart(d[0],0),a=d.pop(),b.setEnd(a,a.length),a=this.containsRange(b),b.detach(),a):this.containsNodeContents(a)},createNodeIterator:function(a,b){v(this);return new k(this,a,b)},getNodes:function(a,b){v(this);return s(this,a,b)},getDocument:function(){return a(this)},collapseBefore:function(a){r(this);this.setEndBefore(a);this.collapse(!1)},collapseAfter:function(a){r(this);this.setStartAfter(a);this.collapse(!0)},getName:function(){return"DomRange"},
equals:function(a){return C.rangesEqual(this,a)},inspect:function(){return o(this)}};D(C,M,function(a){r(a);a.startContainer=a.startOffset=a.endContainer=a.endOffset=null;a.collapsed=a.commonAncestorContainer=null;d(a,"detach",null);a._listeners=null});c.rangePrototype=G.prototype;C.rangeProperties=S;C.RangeIterator=i;C.copyComparisonConstants=H;C.createPrototypeRange=D;C.inspect=o;C.getRangeDocument=a;C.rangesEqual=function(a,b){return a.startContainer===b.startContainer&&a.startOffset===b.startOffset&&
a.endContainer===b.endContainer&&a.endOffset===b.endOffset};c.DomRange=C;c.RangeException=q});
rangy.createModule("WrappedRange",function(c){function b(a,b,d,c){var g=a.duplicate();g.collapse(d);var i=g.parentElement();e.isAncestorOf(b,i,!0)||(i=b);if(!i.canHaveHTML)return new f(i.parentNode,e.getNodeIndex(i));var b=e.getDocument(i).createElement("span"),q,k=d?"StartToStart":"StartToEnd";do i.insertBefore(b,b.previousSibling),g.moveToElementText(b);while((q=g.compareEndPoints(k,a))>0&&b.previousSibling);k=b.nextSibling;if(q==-1&&k&&e.isCharacterDataNode(k)){g.setEndPoint(d?"EndToStart":"EndToEnd",
a);if(/[\r\n]/.test(k.data)){i=g.duplicate();d=i.text.replace(/\r\n/g,"\r").length;for(d=i.moveStart("character",d);i.compareEndPoints("StartToEnd",i)==-1;)d++,i.moveStart("character",1)}else d=g.text.length;i=new f(k,d)}else k=(c||!d)&&b.previousSibling,i=(d=(c||d)&&b.nextSibling)&&e.isCharacterDataNode(d)?new f(d,0):k&&e.isCharacterDataNode(k)?new f(k,k.length):new f(i,e.getNodeIndex(b));b.parentNode.removeChild(b);return i}function a(a,b){var d,c,f=a.offset,g=e.getDocument(a.node),q=g.body.createTextRange(),
k=e.isCharacterDataNode(a.node);k?(d=a.node,c=d.parentNode):(d=a.node.childNodes,d=f<d.length?d[f]:null,c=a.node);g=g.createElement("span");g.innerHTML="&#feff;";d?c.insertBefore(g,d):c.appendChild(g);q.moveToElementText(g);q.collapse(!b);c.removeChild(g);if(k)q[b?"moveStart":"moveEnd"]("character",f);return q}c.requireModules(["DomUtil","DomRange"]);var d,e=c.dom,f=e.DomPosition,g=c.DomRange;if(c.features.implementsDomRange&&(!c.features.implementsTextRange||!c.config.preferTextRange))(function(){function a(b){for(var d=
c.length,e;d--;)e=c[d],b[e]=b.nativeRange[e]}var b,c=g.rangeProperties,f;d=function(b){if(!b)throw Error("Range must be specified");this.nativeRange=b;a(this)};g.createPrototypeRange(d,function(a,b,d,c,e){var f=a.endContainer!==c||a.endOffset!=e;if(a.startContainer!==b||a.startOffset!=d||f)a.setEnd(c,e),a.setStart(b,d)},function(a){a.nativeRange.detach();a.detached=!0;for(var b=c.length,d;b--;)d=c[b],a[d]=null});b=d.prototype;b.selectNode=function(b){this.nativeRange.selectNode(b);a(this)};b.deleteContents=
function(){this.nativeRange.deleteContents();a(this)};b.extractContents=function(){var b=this.nativeRange.extractContents();a(this);return b};b.cloneContents=function(){return this.nativeRange.cloneContents()};b.surroundContents=function(b){this.nativeRange.surroundContents(b);a(this)};b.collapse=function(b){this.nativeRange.collapse(b);a(this)};b.cloneRange=function(){return new d(this.nativeRange.cloneRange())};b.refresh=function(){a(this)};b.toString=function(){return this.nativeRange.toString()};
var h=document.createTextNode("test");e.getBody(document).appendChild(h);var i=document.createRange();i.setStart(h,0);i.setEnd(h,0);try{i.setStart(h,1),b.setStart=function(b,d){this.nativeRange.setStart(b,d);a(this)},b.setEnd=function(b,d){this.nativeRange.setEnd(b,d);a(this)},f=function(b){return function(d){this.nativeRange[b](d);a(this)}}}catch(q){b.setStart=function(b,d){try{this.nativeRange.setStart(b,d)}catch(c){this.nativeRange.setEnd(b,d),this.nativeRange.setStart(b,d)}a(this)},b.setEnd=function(b,
d){try{this.nativeRange.setEnd(b,d)}catch(c){this.nativeRange.setStart(b,d),this.nativeRange.setEnd(b,d)}a(this)},f=function(b,d){return function(c){try{this.nativeRange[b](c)}catch(e){this.nativeRange[d](c),this.nativeRange[b](c)}a(this)}}}b.setStartBefore=f("setStartBefore","setEndBefore");b.setStartAfter=f("setStartAfter","setEndAfter");b.setEndBefore=f("setEndBefore","setStartBefore");b.setEndAfter=f("setEndAfter","setStartAfter");i.selectNodeContents(h);b.selectNodeContents=i.startContainer==
h&&i.endContainer==h&&i.startOffset==0&&i.endOffset==h.length?function(b){this.nativeRange.selectNodeContents(b);a(this)}:function(a){this.setStart(a,0);this.setEnd(a,g.getEndOffset(a))};i.selectNodeContents(h);i.setEnd(h,3);f=document.createRange();f.selectNodeContents(h);f.setEnd(h,4);f.setStart(h,2);b.compareBoundaryPoints=i.compareBoundaryPoints(i.START_TO_END,f)==-1&i.compareBoundaryPoints(i.END_TO_START,f)==1?function(a,b){b=b.nativeRange||b;if(a==b.START_TO_END)a=b.END_TO_START;else if(a==
b.END_TO_START)a=b.START_TO_END;return this.nativeRange.compareBoundaryPoints(a,b)}:function(a,b){return this.nativeRange.compareBoundaryPoints(a,b.nativeRange||b)};e.getBody(document).removeChild(h);i.detach();f.detach()})(),c.createNativeRange=function(a){return(a||document).createRange()};else if(c.features.implementsTextRange){d=function(a){this.textRange=a;this.refresh()};d.prototype=new g(document);d.prototype.refresh=function(){var a,d,c=this.textRange;a=c.parentElement();var f=c.duplicate();
f.collapse(!0);d=f.parentElement();f=c.duplicate();f.collapse(!1);c=f.parentElement();d=d==c?d:e.getCommonAncestor(d,c);d=d==a?d:e.getCommonAncestor(a,d);this.textRange.compareEndPoints("StartToEnd",this.textRange)==0?d=a=b(this.textRange,d,!0,!0):(a=b(this.textRange,d,!0,!1),d=b(this.textRange,d,!1,!1));this.setStart(a.node,a.offset);this.setEnd(d.node,d.offset)};g.copyComparisonConstants(d);var h=function(){return this}();if(typeof h.Range=="undefined")h.Range=d;c.createNativeRange=function(a){return(a||
document).body.createTextRange()}}if(c.features.implementsTextRange)d.rangeToTextRange=function(b){if(b.collapsed)return a(new f(b.startContainer,b.startOffset),!0);else{var d=a(new f(b.startContainer,b.startOffset),!0),c=a(new f(b.endContainer,b.endOffset),!1),b=e.getDocument(b.startContainer).body.createTextRange();b.setEndPoint("StartToStart",d);b.setEndPoint("EndToEnd",c);return b}};d.prototype.getName=function(){return"WrappedRange"};c.WrappedRange=d;c.createRange=function(a){return new d(c.createNativeRange(a||
document))};c.createRangyRange=function(a){return new g(a||document)};c.createIframeRange=function(a){return c.createRange(e.getIframeDocument(a))};c.createIframeRangyRange=function(a){return c.createRangyRange(e.getIframeDocument(a))};c.addCreateMissingNativeApiListener(function(a){a=a.document;if(typeof a.createRange=="undefined")a.createRange=function(){return c.createRange(this)};a=a=null})});
rangy.createModule("WrappedSelection",function(c,b){function a(a){return(a||window).getSelection()}function d(a){return(a||window).document.selection}function e(a,b,d){var c=d?"end":"start",d=d?"start":"end";a.anchorNode=b[c+"Container"];a.anchorOffset=b[c+"Offset"];a.focusNode=b[d+"Container"];a.focusOffset=b[d+"Offset"]}function f(a){a.anchorNode=a.focusNode=null;a.anchorOffset=a.focusOffset=0;a.rangeCount=0;a.isCollapsed=!0;a._ranges.length=0}function g(a){var b;if(a instanceof x){if(b=a._selectionNativeRange,
!b)b=c.createNativeRange(k.getDocument(a.startContainer)),b.setEnd(a.endContainer,a.endOffset),b.setStart(a.startContainer,a.startOffset),a._selectionNativeRange=b,a.attachListener("detach",function(){this._selectionNativeRange=null})}else a instanceof r?b=a.nativeRange:c.features.implementsDomRange&&a instanceof k.getWindow(a.startContainer).Range&&(b=a);return b}function h(a){var b=a.getNodes(),d;a:if(!b.length||b[0].nodeType!=1)d=!1;else{d=1;for(var c=b.length;d<c;++d)if(!k.isAncestorOf(b[0],b[d])){d=
!1;break a}d=!0}if(!d)throw Error("getSingleElementFromRange: range "+a.inspect()+" did not consist of a single element");return b[0]}function j(a,b){var d=new r(b);a._ranges=[d];e(a,d,!1);a.rangeCount=1;a.isCollapsed=d.collapsed}function n(a){a._ranges.length=0;if(a.docSelection.type=="None")f(a);else{var b=a.docSelection.createRange();if(b&&typeof b.text!="undefined")j(a,b);else{a.rangeCount=b.length;for(var d,g=k.getDocument(b.item(0)),D=0;D<a.rangeCount;++D)d=c.createRange(g),d.selectNode(b.item(D)),
a._ranges.push(d);a.isCollapsed=a.rangeCount==1&&a._ranges[0].collapsed;e(a,a._ranges[a.rangeCount-1],!1)}}}function l(a,b){for(var d=a.docSelection.createRange(),c=h(b),e=k.getDocument(d.item(0)),e=k.getBody(e).createControlRange(),f=0,g=d.length;f<g;++f)e.add(d.item(f));try{e.add(c)}catch(D){throw Error("addRange(): Element within the specified Range could not be added to control selection (does it have layout?)");}e.select();n(a)}function s(a,b,d){this.nativeSelection=a;this.docSelection=b;this._ranges=
[];this.win=d;this.refresh()}function o(a,b){for(var d=k.getDocument(b[0].startContainer),d=k.getBody(d).createControlRange(),c=0,e;c<rangeCount;++c){e=h(b[c]);try{d.add(e)}catch(f){throw Error("setRanges(): Element within the one of the specified Ranges could not be added to control selection (does it have layout?)");}}d.select();n(a)}function i(a,b){if(a.anchorNode&&k.getDocument(a.anchorNode)!==k.getDocument(b))throw new w("WRONG_DOCUMENT_ERR");}function q(a){var b=[],d=new E(a.anchorNode,a.anchorOffset),
c=new E(a.focusNode,a.focusOffset),e=typeof a.getName=="function"?a.getName():"Selection";if(typeof a.rangeCount!="undefined")for(var f=0,g=a.rangeCount;f<g;++f)b[f]=x.inspect(a.getRangeAt(f));return"["+e+"(Ranges: "+b.join(", ")+")(anchor: "+d.inspect()+", focus: "+c.inspect()+"]"}c.requireModules(["DomUtil","DomRange","WrappedRange"]);c.config.checkSelectionRanges=!0;var k=c.dom,p=c.util,x=c.DomRange,r=c.WrappedRange,w=c.DOMException,E=k.DomPosition,A,z,y=c.util.isHostMethod(window,"getSelection"),
v=c.util.isHostObject(document,"selection"),G=v&&(!y||c.config.preferTextRange);G?(A=d,c.isSelectionValid=function(a){var a=(a||window).document,b=a.selection;return b.type!="None"||k.getDocument(b.createRange().parentElement())==a}):y?(A=a,c.isSelectionValid=function(){return!0}):b.fail("Neither document.selection or window.getSelection() detected.");c.getNativeSelection=A;var y=A(),J=c.createNativeRange(document),H=k.getBody(document),F=p.areHostObjects(y,p.areHostProperties(y,["anchorOffset","focusOffset"]));
c.features.selectionHasAnchorAndFocus=F;var D=p.isHostMethod(y,"extend");c.features.selectionHasExtend=D;var O=typeof y.rangeCount=="number";c.features.selectionHasRangeCount=O;var M=!1,C=!0;p.areHostMethods(y,["addRange","getRangeAt","removeAllRanges"])&&typeof y.rangeCount=="number"&&c.features.implementsDomRange&&function(){var a=document.createElement("iframe");H.appendChild(a);var b=k.getIframeDocument(a);b.open();b.write("<html><head></head><body>12</body></html>");b.close();var d=k.getIframeWindow(a).getSelection(),
c=b.documentElement.lastChild.firstChild,b=b.createRange();b.setStart(c,1);b.collapse(!0);d.addRange(b);C=d.rangeCount==1;d.removeAllRanges();var e=b.cloneRange();b.setStart(c,0);e.setEnd(c,2);d.addRange(b);d.addRange(e);M=d.rangeCount==2;b.detach();e.detach();H.removeChild(a)}();c.features.selectionSupportsMultipleRanges=M;c.features.collapsedNonEditableSelectionsSupported=C;var m=!1,u;H&&p.isHostMethod(H,"createControlRange")&&(u=H.createControlRange(),p.areHostProperties(u,["item","add"])&&(m=
!0));c.features.implementsControlRange=m;z=F?function(a){return a.anchorNode===a.focusNode&&a.anchorOffset===a.focusOffset}:function(a){return a.rangeCount?a.getRangeAt(a.rangeCount-1).collapsed:!1};var B;p.isHostMethod(y,"getRangeAt")?B=function(a,b){try{return a.getRangeAt(b)}catch(d){return null}}:F&&(B=function(a){var b=k.getDocument(a.anchorNode),b=c.createRange(b);b.setStart(a.anchorNode,a.anchorOffset);b.setEnd(a.focusNode,a.focusOffset);b.collapsed!==this.isCollapsed&&(b.setStart(a.focusNode,
a.focusOffset),b.setEnd(a.anchorNode,a.anchorOffset));return b});c.getSelection=function(a){var a=a||window,b=a._rangySelection,c=A(a),e=v?d(a):null;b?(b.nativeSelection=c,b.docSelection=e,b.refresh(a)):(b=new s(c,e,a),a._rangySelection=b);return b};c.getIframeSelection=function(a){return c.getSelection(k.getIframeWindow(a))};u=s.prototype;if(!G&&F&&p.areHostMethods(y,["removeAllRanges","addRange"])){u.removeAllRanges=function(){this.nativeSelection.removeAllRanges();f(this)};var N=function(a,b){var d=
x.getRangeDocument(b),d=c.createRange(d);d.collapseToPoint(b.endContainer,b.endOffset);a.nativeSelection.addRange(g(d));a.nativeSelection.extend(b.startContainer,b.startOffset);a.refresh()};u.addRange=O?function(a,b){if(m&&v&&this.docSelection.type=="Control")l(this,a);else if(b&&D)N(this,a);else{var d;M?d=this.rangeCount:(this.removeAllRanges(),d=0);this.nativeSelection.addRange(g(a));this.rangeCount=this.nativeSelection.rangeCount;this.rangeCount==d+1?(c.config.checkSelectionRanges&&(d=B(this.nativeSelection,
this.rangeCount-1))&&!x.rangesEqual(d,a)&&(a=new r(d)),this._ranges[this.rangeCount-1]=a,e(this,a,K(this.nativeSelection)),this.isCollapsed=z(this)):this.refresh()}}:function(a,b){b&&D?N(this,a):(this.nativeSelection.addRange(g(a)),this.refresh())};u.setRanges=function(a){if(m&&a.length>1)o(this,a);else{this.removeAllRanges();for(var b=0,d=a.length;b<d;++b)this.addRange(a[b])}}}else if(p.isHostMethod(y,"empty")&&p.isHostMethod(J,"select")&&m&&G)u.removeAllRanges=function(){try{if(this.docSelection.empty(),
this.docSelection.type!="None"){var a;if(this.anchorNode)a=k.getDocument(this.anchorNode);else if(this.docSelection.type=="Control"){var b=this.docSelection.createRange();b.length&&(a=k.getDocument(b.item(0)).body.createTextRange())}a&&(a.body.createTextRange().select(),this.docSelection.empty())}}catch(d){}f(this)},u.addRange=function(a){this.docSelection.type=="Control"?l(this,a):(r.rangeToTextRange(a).select(),this._ranges[0]=a,this.rangeCount=1,this.isCollapsed=this._ranges[0].collapsed,e(this,
a,!1))},u.setRanges=function(a){this.removeAllRanges();var b=a.length;b>1?o(this,a):b&&this.addRange(a[0])};else return b.fail("No means of selecting a Range or TextRange was found"),!1;u.getRangeAt=function(a){if(a<0||a>=this.rangeCount)throw new w("INDEX_SIZE_ERR");else return this._ranges[a]};var I;if(G)I=function(a){var b;c.isSelectionValid(a.win)?b=a.docSelection.createRange():(b=k.getBody(a.win.document).createTextRange(),b.collapse(!0));a.docSelection.type=="Control"?n(a):b&&typeof b.text!=
"undefined"?j(a,b):f(a)};else if(p.isHostMethod(y,"getRangeAt")&&typeof y.rangeCount=="number")I=function(a){if(m&&v&&a.docSelection.type=="Control")n(a);else if(a._ranges.length=a.rangeCount=a.nativeSelection.rangeCount,a.rangeCount){for(var b=0,d=a.rangeCount;b<d;++b)a._ranges[b]=new c.WrappedRange(a.nativeSelection.getRangeAt(b));e(a,a._ranges[a.rangeCount-1],K(a.nativeSelection));a.isCollapsed=z(a)}else f(a)};else if(F&&typeof y.isCollapsed=="boolean"&&typeof J.collapsed=="boolean"&&c.features.implementsDomRange)I=
function(a){var b;b=a.nativeSelection;b.anchorNode?(b=B(b,0),a._ranges=[b],a.rangeCount=1,b=a.nativeSelection,a.anchorNode=b.anchorNode,a.anchorOffset=b.anchorOffset,a.focusNode=b.focusNode,a.focusOffset=b.focusOffset,a.isCollapsed=z(a)):f(a)};else return b.fail("No means of obtaining a Range or TextRange from the user's selection was found"),!1;u.refresh=function(a){var b=a?this._ranges.slice(0):null;I(this);if(a){a=b.length;if(a!=this._ranges.length)return!1;for(;a--;)if(!x.rangesEqual(b[a],this._ranges[a]))return!1;
return!0}};var P=function(a,b){var d=a.getAllRanges(),c=!1;a.removeAllRanges();for(var e=0,g=d.length;e<g;++e)c||b!==d[e]?a.addRange(d[e]):c=!0;a.rangeCount||f(a)};u.removeRange=m?function(a){if(this.docSelection.type=="Control"){for(var b=this.docSelection.createRange(),a=h(a),d=k.getDocument(b.item(0)),d=k.getBody(d).createControlRange(),c,e=!1,f=0,g=b.length;f<g;++f)c=b.item(f),c!==a||e?d.add(b.item(f)):e=!0;d.select();n(this)}else P(this,a)}:function(a){P(this,a)};var K;!G&&F&&c.features.implementsDomRange?
(K=function(a){var b=!1;a.anchorNode&&(b=k.comparePoints(a.anchorNode,a.anchorOffset,a.focusNode,a.focusOffset)==1);return b},u.isBackwards=function(){return K(this)}):K=u.isBackwards=function(){return!1};u.toString=function(){for(var a=[],b=0,d=this.rangeCount;b<d;++b)a[b]=""+this._ranges[b];return a.join("")};u.collapse=function(a,b){i(this,a);var d=c.createRange(k.getDocument(a));d.collapseToPoint(a,b);this.removeAllRanges();this.addRange(d);this.isCollapsed=!0};u.collapseToStart=function(){if(this.rangeCount){var a=
this._ranges[0];this.collapse(a.startContainer,a.startOffset)}else throw new w("INVALID_STATE_ERR");};u.collapseToEnd=function(){if(this.rangeCount){var a=this._ranges[this.rangeCount-1];this.collapse(a.endContainer,a.endOffset)}else throw new w("INVALID_STATE_ERR");};u.selectAllChildren=function(a){i(this,a);var b=c.createRange(k.getDocument(a));b.selectNodeContents(a);this.removeAllRanges();this.addRange(b)};u.deleteFromDocument=function(){if(m&&v&&this.docSelection.type=="Control"){for(var a=this.docSelection.createRange(),
b;a.length;)b=a.item(0),a.remove(b),b.parentNode.removeChild(b);this.refresh()}else if(this.rangeCount){a=this.getAllRanges();this.removeAllRanges();b=0;for(var d=a.length;b<d;++b)a[b].deleteContents();this.addRange(a[d-1])}};u.getAllRanges=function(){return this._ranges.slice(0)};u.setSingleRange=function(a){this.setRanges([a])};u.containsNode=function(a,b){for(var d=0,c=this._ranges.length;d<c;++d)if(this._ranges[d].containsNode(a,b))return!0;return!1};u.toHtml=function(){var a="";if(this.rangeCount){for(var a=
x.getRangeDocument(this._ranges[0]).createElement("div"),b=0,d=this._ranges.length;b<d;++b)a.appendChild(this._ranges[b].cloneContents());a=a.innerHTML}return a};u.getName=function(){return"WrappedSelection"};u.inspect=function(){return q(this)};u.detach=function(){this.win=this.anchorNode=this.focusNode=this.win._rangySelection=null};s.inspect=q;c.Selection=s;c.selectionPrototype=u;c.addCreateMissingNativeApiListener(function(a){if(typeof a.getSelection=="undefined")a.getSelection=function(){return c.getSelection(this)};
a=null})});
rangy.createModule("CssClassApplier",function(c,b){function a(a,b){return a.className&&RegExp("(?:^|\\s)"+b+"(?:\\s|$)").test(a.className)}function d(b,d){b.className?a(b,d)||(b.className+=" "+d):b.className=d}function e(a){return a.split(/\s+/).sort().join(" ")}function f(a,b){return e(a.className)==e(b.className)}function g(a){for(var b=a.parentNode;a.hasChildNodes();)b.insertBefore(a.firstChild,a);b.removeChild(a)}function h(a,b){var d=a.cloneRange();d.selectNodeContents(b);var c=d.intersection(a),c=
c?c.toString():"";d.detach();return c!=""}function j(a){return a.getNodes([3],function(b){return h(a,b)})}function n(a,b){if(a.attributes.length!=b.attributes.length)return!1;for(var d=0,c=a.attributes.length,e,f;d<c;++d)if(e=a.attributes[d],f=e.name,f!="class"){f=b.attributes.getNamedItem(f);if(e.specified!=f.specified)return!1;if(e.specified&&e.nodeValue!==f.nodeValue)return!1}return!0}function l(a,b){for(var d=0,c=a.attributes.length,e;d<c;++d)if(e=a.attributes[d].name,(!b||!w.arrayContains(b,
e))&&a.attributes[d].specified&&e!="class")return!0;return!1}function s(a){var b;return a&&a.nodeType==1&&((b=a.parentNode)&&b.nodeType==9&&b.designMode=="on"||z(a)&&!z(a.parentNode))}function o(a){return(z(a)||a.nodeType!=1&&z(a.parentNode))&&!s(a)}function i(a){return a&&a.nodeType==1&&!y.test(A(a,"display"))}function q(a){if(a.data.length==0)return!0;if(v.test(a.data))return!1;switch(A(a.parentNode,"whiteSpace")){case "pre":case "pre-wrap":case "-moz-pre-wrap":return!1;case "pre-line":if(/[\r\n]/.test(a.data))return!1}return i(a.previousSibling)||
i(a.nextSibling)}function k(a,d,c,e){var f,g=c==0;if(w.isAncestorOf(d,a))throw b.createError("descendant is ancestor of node");if(w.isCharacterDataNode(d))if(c==0)c=w.getNodeIndex(d),d=d.parentNode;else if(c==d.length)c=w.getNodeIndex(d)+1,d=d.parentNode;else throw b.createError("splitNodeAt should not be called with offset in the middle of a data node ("+c+" in "+d.data);if(w.isCharacterDataNode(d)?c==0?d.previousSibling:c==d.length?d.nextSibling:1:c>0&&c<d.childNodes.length){if(!f){f=d.cloneNode(!1);
for(f.id&&f.removeAttribute("id");g=d.childNodes[c];)f.appendChild(g);w.insertAfter(f,d)}return d==a?f:k(a,f.parentNode,w.getNodeIndex(f),e)}else if(a!=d)return f=d.parentNode,d=w.getNodeIndex(d),g||d++,k(a,f,d,e);return a}function p(a){var b=a?"nextSibling":"previousSibling";return function(d,c){var e=d.parentNode,g=d[b];if(g){if(g&&g.nodeType==3)return g}else if(c&&(g=e[b])&&g.nodeType==1&&e.tagName==g.tagName&&f(e,g)&&n(e,g))return g[a?"firstChild":"lastChild"];return null}}function x(a){this.firstTextNode=
(this.isElementMerge=a.nodeType==1)?a.lastChild:a;this.textNodes=[this.firstTextNode]}function r(a,b,d){this.cssClass=a;var c,f,g=null;if(typeof b=="object"&&b!==null){d=b.tagNames;g=b.elementProperties;for(c=0;f=H[c++];)b.hasOwnProperty(f)&&(this[f]=b[f]);c=b.normalize}else c=b;this.normalize=typeof c=="undefined"?!0:c;this.attrExceptions=[];c=document.createElement(this.elementTagName);this.elementProperties={};for(var i in g)g.hasOwnProperty(i)&&(F.hasOwnProperty(i)&&(i=F[i]),c[i]=g[i],this.elementProperties[i]=
c[i],this.attrExceptions.push(i));this.elementSortedClassName=this.elementProperties.hasOwnProperty("className")?e(this.elementProperties.className+" "+a):a;this.applyToAnyTagName=!1;a=typeof d;if(a=="string")d=="*"?this.applyToAnyTagName=!0:this.tagNames=d.toLowerCase().replace(/^\s\s*/,"").replace(/\s\s*$/,"").split(/\s*,\s*/);else if(a=="object"&&typeof d.length=="number"){this.tagNames=[];c=0;for(a=d.length;c<a;++c)d[c]=="*"?this.applyToAnyTagName=!0:this.tagNames.push(d[c].toLowerCase())}else this.tagNames=
[this.elementTagName]}c.requireModules(["WrappedSelection","WrappedRange"]);var w=c.dom,E=function(){function a(b,d,c){return d&&c?" ":""}return function(b,d){if(b.className)b.className=b.className.replace(RegExp("(?:^|\\s)"+d+"(?:\\s|$)"),a)}}(),A;typeof window.getComputedStyle!="undefined"?A=function(a,b){return w.getWindow(a).getComputedStyle(a,null)[b]}:typeof document.documentElement.currentStyle!="undefined"?A=function(a,b){return a.currentStyle[b]}:b.fail("No means of obtaining computed style properties found");
var z;(function(){z=typeof document.createElement("div").isContentEditable=="boolean"?function(a){return a&&a.nodeType==1&&a.isContentEditable}:function(a){return!a||a.nodeType!=1||a.contentEditable=="false"?!1:a.contentEditable=="true"||z(a.parentNode)}})();var y=/^inline(-block|-table)?$/i,v=/[^\r\n\t\f \u200B]/,G=p(!1),J=p(!0);x.prototype={doMerge:function(){for(var a=[],b,d,c=0,e=this.textNodes.length;c<e;++c)b=this.textNodes[c],d=b.parentNode,a[c]=b.data,c&&(d.removeChild(b),d.hasChildNodes()||
d.parentNode.removeChild(d));return this.firstTextNode.data=a=a.join("")},getLength:function(){for(var a=this.textNodes.length,b=0;a--;)b+=this.textNodes[a].length;return b},toString:function(){for(var a=[],b=0,d=this.textNodes.length;b<d;++b)a[b]="'"+this.textNodes[b].data+"'";return"[Merge("+a.join(",")+")]"}};var H=["elementTagName","ignoreWhiteSpace","applyToEditableOnly"],F={"class":"className"};r.prototype={elementTagName:"span",elementProperties:{},ignoreWhiteSpace:!0,applyToEditableOnly:!1,
hasClass:function(b){return b.nodeType==1&&w.arrayContains(this.tagNames,b.tagName.toLowerCase())&&a(b,this.cssClass)},getSelfOrAncestorWithClass:function(a){for(;a;){if(this.hasClass(a,this.cssClass))return a;a=a.parentNode}return null},isModifiable:function(a){return!this.applyToEditableOnly||o(a)},isIgnorableWhiteSpaceNode:function(a){return this.ignoreWhiteSpace&&a&&a.nodeType==3&&q(a)},postApply:function(a,b,d){for(var c=a[0],e=a[a.length-1],f=[],g,i=c,k=e,j=0,h=e.length,q,l,p=0,n=a.length;p<
n;++p)if(q=a[p],l=G(q,!d)){g||(g=new x(l),f.push(g));g.textNodes.push(q);if(q===c)i=g.firstTextNode,j=i.length;if(q===e)k=g.firstTextNode,h=g.getLength()}else g=null;if(a=J(e,!d))g||(g=new x(e),f.push(g)),g.textNodes.push(a);if(f.length){p=0;for(n=f.length;p<n;++p)f[p].doMerge();b.setStart(i,j);b.setEnd(k,h)}},createContainer:function(a){a=a.createElement(this.elementTagName);c.util.extend(a,this.elementProperties);d(a,this.cssClass);return a},applyToTextNode:function(a){var b=a.parentNode;b.childNodes.length==
1&&w.arrayContains(this.tagNames,b.tagName.toLowerCase())?d(b,this.cssClass):(b=this.createContainer(w.getDocument(a)),a.parentNode.insertBefore(b,a),b.appendChild(a))},isRemovable:function(a){var b;if(b=a.tagName.toLowerCase()==this.elementTagName)if(b=e(a.className)==this.elementSortedClassName){var d;a:{b=this.elementProperties;for(d in b)if(b.hasOwnProperty(d)&&a[d]!==b[d]){d=!1;break a}d=!0}b=d&&!l(a,this.attrExceptions)&&this.isModifiable(a)}return b},undoToTextNode:function(a,b,d){b.containsNode(d)||
(a=b.cloneRange(),a.selectNode(d),a.isPointInRange(b.endContainer,b.endOffset)&&(k(d,b.endContainer,b.endOffset,[b]),b.setEndAfter(d)),a.isPointInRange(b.startContainer,b.startOffset)&&(d=k(d,b.startContainer,b.startOffset,[b])));this.isRemovable(d)?g(d):E(d,this.cssClass)},applyToRange:function(a){a.splitBoundaries();var b=j(a);if(b.length){for(var d,c=0,e=b.length;c<e;++c)d=b[c],!this.isIgnorableWhiteSpaceNode(d)&&!this.getSelfOrAncestorWithClass(d)&&this.isModifiable(d)&&this.applyToTextNode(d);
a.setStart(b[0],0);d=b[b.length-1];a.setEnd(d,d.length);this.normalize&&this.postApply(b,a,!1)}},applyToSelection:function(a){var a=c.getSelection(a||window),b,d=a.getAllRanges();a.removeAllRanges();for(var e=d.length;e--;)b=d[e],this.applyToRange(b),a.addRange(b)},undoToRange:function(a){a.splitBoundaries();var b=j(a),d,c,e=b[b.length-1];if(b.length){for(var f=0,g=b.length;f<g;++f)d=b[f],(c=this.getSelfOrAncestorWithClass(d))&&this.isModifiable(d)&&this.undoToTextNode(d,a,c),a.setStart(b[0],0),a.setEnd(e,
e.length);this.normalize&&this.postApply(b,a,!0)}},undoToSelection:function(a){var a=c.getSelection(a||window),b=a.getAllRanges(),d;a.removeAllRanges();for(var e=0,f=b.length;e<f;++e)d=b[e],this.undoToRange(d),a.addRange(d)},getTextSelectedByRange:function(a,b){var d=b.cloneRange();d.selectNodeContents(a);var c=d.intersection(b),c=c?c.toString():"";d.detach();return c},isAppliedToRange:function(a){if(a.collapsed)return!!this.getSelfOrAncestorWithClass(a.commonAncestorContainer);else{for(var b=a.getNodes([3]),
d=0,c;c=b[d++];)if(!this.isIgnorableWhiteSpaceNode(c)&&h(a,c)&&this.isModifiable(c)&&!this.getSelfOrAncestorWithClass(c))return!1;return!0}},isAppliedToSelection:function(a){for(var a=c.getSelection(a||window).getAllRanges(),b=a.length;b--;)if(!this.isAppliedToRange(a[b]))return!1;return!0},toggleRange:function(a){this.isAppliedToRange(a)?this.undoToRange(a):this.applyToRange(a)},toggleSelection:function(a){this.isAppliedToSelection(a)?this.undoToSelection(a):this.applyToSelection(a)},detach:function(){}};
r.util={hasClass:a,addClass:d,removeClass:E,hasSameClasses:f,replaceWithOwnChildren:g,elementsHaveSameNonClassAttributes:n,elementHasNonClassAttributes:l,splitNodeAt:k,isEditableElement:z,isEditingHost:s,isEditable:o};c.CssClassApplier=r;c.createCssClassApplier=function(a,b,d){return new r(a,b,d)}});
rangy.createModule("SaveRestore",function(c,b){function a(a,b){var d="selectionBoundary_"+ +new Date+"_"+(""+Math.random()).slice(2),c,e=g.getDocument(a.startContainer),f=a.cloneRange();f.collapse(b);c=e.createElement("span");c.id=d;c.style.lineHeight="0";c.style.display="none";c.className="rangySelectionBoundary";c.appendChild(e.createTextNode(h));f.insertNode(c);f.detach();return c}function d(a,d,c,e){(a=(a||document).getElementById(c))?(d[e?"setStartBefore":"setEndBefore"](a),a.parentNode.removeChild(a)):
b.warn("Marker element has been removed. Cannot restore selection.")}function e(a,b){return b.compareBoundaryPoints(a.START_TO_START,a)}function f(a,b){var d=(a||document).getElementById(b);d&&d.parentNode.removeChild(d)}c.requireModules(["DomUtil","DomRange","WrappedRange"]);var g=c.dom,h="\ufeff";c.saveSelection=function(d){var d=d||window,f=d.document;if(c.isSelectionValid(d)){var g=c.getSelection(d),h=g.getAllRanges(),o=[],i,q;h.sort(e);for(var k=0,p=h.length;k<p;++k)i=h[k],i.collapsed?(q=a(i,
!1),o.push({markerId:q.id,collapsed:!0})):(q=a(i,!1),i=a(i,!0),o[k]={startMarkerId:i.id,endMarkerId:q.id,collapsed:!1,backwards:h.length==1&&g.isBackwards()});for(k=p-1;k>=0;--k)i=h[k],i.collapsed?i.collapseBefore((f||document).getElementById(o[k].markerId)):(i.setEndBefore((f||document).getElementById(o[k].endMarkerId)),i.setStartAfter((f||document).getElementById(o[k].startMarkerId)));g.setRanges(h);return{win:d,doc:f,rangeInfos:o,restored:!1}}else b.warn("Cannot save selection. This usually happens when the selection is collapsed and the selection document has lost focus.")};
c.restoreSelection=function(a,e){if(!a.restored){for(var f=a.rangeInfos,g=c.getSelection(a.win),h=[],i=f.length,q=i-1,k,p;q>=0;--q){k=f[q];p=c.createRange(a.doc);if(k.collapsed)if(k=(a.doc||document).getElementById(k.markerId)){k.style.display="inline";var x=k.previousSibling;x&&x.nodeType==3?(k.parentNode.removeChild(k),p.collapseToPoint(x,x.length)):(p.collapseBefore(k),k.parentNode.removeChild(k))}else b.warn("Marker element has been removed. Cannot restore selection.");else d(a.doc,p,k.startMarkerId,
!0),d(a.doc,p,k.endMarkerId,!1);i==1&&p.normalizeBoundaries();h[q]=p}i==1&&e&&c.features.selectionHasExtend&&f[0].backwards?(g.removeAllRanges(),g.addRange(h[0],!0)):g.setRanges(h);a.restored=!0}};c.removeMarkerElement=f;c.removeMarkers=function(a){for(var b=a.rangeInfos,d=0,c=b.length,e;d<c;++d)e=b[d],e.collapsed?f(a.doc,e.markerId):(f(a.doc,e.startMarkerId),f(a.doc,e.endMarkerId))}});
rangy.createModule("Serializer",function(c,b){function a(b,d){var d=d||[],c=b.nodeType,e=b.childNodes,f=e.length,g=[c,b.nodeName,f].join(":"),h="",j="";switch(c){case 3:h=b.nodeValue.replace(/</g,"&lt;").replace(/>/g,"&gt;");break;case 8:h="<\!--"+b.nodeValue.replace(/</g,"&lt;").replace(/>/g,"&gt;")+"--\>";break;default:h="<"+g+">",j="</>"}h&&d.push(h);for(c=0;c<f;++c)a(e[c],d);j&&d.push(j);return d}function d(b){b=a(b).join("");return s(b).toString(16)}function e(a,b,d){for(var c=[],e=a,d=d||o.getDocument(a).documentElement;e&&
e!=d;)c.push(o.getNodeIndex(e,!0)),e=e.parentNode;return c.join("/")+":"+b}function f(a,d,c){d?c||o.getDocument(d):d=(c||document).documentElement;for(var a=a.split(":"),c=a[0]?a[0].split("/"):[],e=c.length,f;e--;)if(f=parseInt(c[e],10),f<d.childNodes.length)d=d.childNodes[parseInt(c[e],10)];else throw b.createError("deserializePosition failed: node "+o.inspectNode(d)+" has no child with index "+f+", "+e);return new o.DomPosition(d,parseInt(a[1],10))}function g(a,b,f){f=f||c.DomRange.getRangeDocument(a).documentElement;
if(!o.isAncestorOf(f,a.commonAncestorContainer,!0))throw Error("serializeRange: range is not wholly contained within specified root node");a=e(a.startContainer,a.startOffset,f)+","+e(a.endContainer,a.endOffset,f);b||(a+="{"+d(f)+"}");return a}function h(a,b,e){b?e=e||o.getDocument(b):(e=e||document,b=e.documentElement);var a=/^([^,]+),([^,\{]+)({([^}]+)})?$/.exec(a),g=a[4],h=d(b);if(g&&g!==d(b))throw Error("deserializeRange: checksums of serialized range root node ("+g+") and target root node ("+
h+") do not match");g=f(a[1],b,e);b=f(a[2],b,e);e=c.createRange(e);e.setStart(g.node,g.offset);e.setEnd(b.node,b.offset);return e}function j(a,b,c){b?c||o.getDocument(b):b=(c||document).documentElement;a=/^([^,]+),([^,]+)({([^}]+)})?$/.exec(a)[3];return!a||a===d(b)}function n(a,b,d){for(var a=a||c.getSelection(),a=a.getAllRanges(),e=[],f=0,h=a.length;f<h;++f)e[f]=g(a[f],b,d);return e.join("|")}function l(a,b,d){b?d=d||o.getWindow(b):(d=d||window,b=d.document.documentElement);for(var a=a.split("|"),
e=c.getSelection(d),f=[],g=0,j=a.length;g<j;++g)f[g]=h(a[g],b,d.document);e.setRanges(f);return e}c.requireModules(["WrappedSelection","WrappedRange"]);(typeof encodeURIComponent=="undefined"||typeof decodeURIComponent=="undefined")&&b.fail("Global object is missing encodeURIComponent and/or decodeURIComponent method");var s=function(){var a=null;return function(b){for(var d=[],c=0,e=b.length,f;c<e;++c)f=b.charCodeAt(c),f<128?d.push(f):f<2048?d.push(f>>6|192,f&63|128):d.push(f>>12|224,f>>6&63|128,
f&63|128);b=-1;if(!a){for(var c=[],e=0,g;e<256;++e){g=e;for(f=8;f--;)(g&1)==1?g=g>>>1^3988292384:g>>>=1;c[e]=g>>>0}a=c}c=a;e=0;for(f=d.length;e<f;++e)g=(b^d[e])&255,b=b>>>8^c[g];return(b^-1)>>>0}}(),o=c.dom;c.serializePosition=e;c.deserializePosition=f;c.serializeRange=g;c.deserializeRange=h;c.canDeserializeRange=j;c.serializeSelection=n;c.deserializeSelection=l;c.canDeserializeSelection=function(a,b,d){var c;b?c=d?d.document:o.getDocument(b):b=(d||window).document.documentElement;for(var a=a.split("|"),
d=0,e=a.length;d<e;++d)if(!j(a[d],b,c))return!1;return!0};c.restoreSelectionFromCookie=function(a){var a=a||window,b;a:{b=a.document.cookie.split(/[;,]/);for(var d=0,c=b.length,e;d<c;++d)if(e=b[d].split("="),e[0].replace(/^\s+/,"")=="rangySerializedSelection"&&(e=e[1])){b=decodeURIComponent(e.replace(/\s+$/,""));break a}b=null}b&&l(b,a.doc)};c.saveSelectionCookie=function(a,b){var a=a||window,b=typeof b=="object"?b:{},d=b.expires?";expires="+b.expires.toUTCString():"",e=b.path?";path="+b.path:"",
f=b.domain?";domain="+b.domain:"",g=b.secure?";secure":"",h=n(c.getSelection(a));a.document.cookie=encodeURIComponent("rangySerializedSelection")+"="+encodeURIComponent(h)+d+e+f+g};c.getElementChecksum=d});
(function(){var c,b;c={attrNamePrefix:"data-",changeIdAttribute:"cid",userIdAttribute:"userid",userNameAttribute:"username",timeAttribute:"time",attrValuePrefix:"",blockEl:"p",stylePrefix:"cts",currentUser:{id:null,name:null},changeTypes:{insertType:{tag:"insert",alias:"ins"},deleteType:{tag:"delete",alias:"del"}},handleEvents:!1,contentEditable:!0,isTracking:!0,doNotTrack:"span#test",avoid:".ice-avoid"};b=function(a,b){a||(a={});if(!a.element)throw Error("`options.element` must be defined for ice construction.");
ice.dom.extend(!0,this,c,a);this.changeIdAttribute=this.attrNamePrefix+this.changeIdAttribute;this.userIdAttribute=this.attrNamePrefix+this.userIdAttribute;this.userNameAttribute=this.attrNamePrefix+this.userNameAttribute;this.timeAttribute=this.attrNamePrefix+this.timeAttribute;this._changes={};this._userStyles={};this._styles={};this._uniqueStyleIndex=0;this._batchChangeid=this._browserType=null;this._uniqueIDIndex=1;this._delBookmark="tempdel";this.isPlaceHoldingDeletes=!1;this.pluginsManager=
new ice.IcePluginManager(this);a.plugins&&this.pluginsManager.usePlugins("ice-init",a.plugins);this.element.setAttribute("contentEditable",this.contentEditable);if(this.handleEvents){var e=this;ice.dom.bind(e.element,"keyup keydown keypress mousedown mouseup",function(a){return e.handleEvent(a)})}this.initializeEnvironment();this.initializeChangeEditor();this.initializeRange();this.pluginsManager.fireEnabled(this.element);b&&b.call(this)};b.prototype={initializeEnvironment:function(){ice.env||(ice.env=
{});ice.env.element=this.element;ice.env.document=this.element.ownerDocument;ice.env.window=ice.env.document.defaultView||ice.env.document.parentWindow||window;ice.env.frame=ice.env.window.frameElement;ice.env.selection=this.selection=new ice.Selection(ice.env.frame)},initializeRange:function(){var a=this.selection.createRange();a.setStart(ice.dom.find(this.element,this.blockEl)[0],0);a.collapse(!0);this.selection.addRange(a);ice.env.frame?ice.env.frame.contentWindow.focus():this.element.focus()},
initializeChangeEditor:function(){var a=this,b=ice.env.document.createElement("div");this.element.childNodes.length?(ice.dom.each(ice.dom.contents(this.element),function(a,c){ice.dom.isBlockElement(c)&&b.appendChild(c)}),b.innerHTML===""&&b.appendChild(ice.dom.create("<"+this.blockEl+" ><br/></"+this.blockEl+">"))):b.appendChild(ice.dom.create("<"+this.blockEl+" ><br/></"+this.blockEl+">"));this.element.innerHTML=b.innerHTML;var c=this._getIceNodeClass("insertType"),f=this._getIceNodeClass("deleteType");
ice.dom.each(ice.dom.find(this.element,"."+c+",."+f),function(b,d){for(var j=0,n="",l=d.className.split(" "),b=0;b<l.length;b++){var s=RegExp(a.stylePrefix+"-(\\d+)").exec(l[b]);s&&(j=s[1]);(s=RegExp("("+c+"|"+f+")").exec(l[b]))&&(n=a._getChangeTypeFromAlias(s[1]))}l=ice.dom.attr(d,a.userIdAttribute);a.setUserStyle(l,Number(j));j=ice.dom.attr(d,a.changeIdAttribute);a._changes[j]={type:n,userid:l,username:ice.dom.attr(d,a.userNameAttribute),time:ice.dom.attr(d,a.timeAttribute)}})},enableChangeTracking:function(){this.isTracking=
!0;this.pluginsManager.fireEnabled(this.element)},disableChangeTracking:function(){this.isTracking=!1;this.pluginsManager.fireDisabled(this.element)},setCurrentUser:function(a){this.currentUser=a},handleEvent:function(a){if(this.isTracking)if(a.type=="mouseup"){var b=this;setTimeout(function(){b.mouseUp(a)},200)}else if(a.type=="mousedown")return this.mouseDown(a);else if(a.type=="keypress"){var c=this.keyPress(a);c||a.preventDefault();return c}else if(a.type=="keydown")return(c=this.keyDown(a))||
a.preventDefault(),c;else a.type=="keyup"&&this.pluginsManager.fireCaretUpdated()},createIceNode:function(a,b){var c=ice.env.document.createElement(this.changeTypes[a].tag);ice.dom.addClass(c,this._getIceNodeClass(a));c.appendChild(b?b:ice.env.document.createTextNode(""));this.addChange(this.changeTypes[a].alias,[c]);this.pluginsManager.fireNodeCreated(c);return c},insert:function(a,b){b?this.selection.addRange(b):b=this.getCurrentRange();typeof a==="string"&&(a=document.createTextNode(a));if(!b.collapsed&&
(this.deleteContents(),b=this.getCurrentRange(),b.startContainer===b.endContainer&&this.element===b.startContainer)){ice.dom.empty(this.element);var c=b.getLastSelectableChild(this.element);b.setStartAfter(c);b.collapse(!0)}this._moveRangeToValidTrackingPos(b);c=this.startBatchChange();this._insertNode(a||document.createTextNode("\ufeff"),b,!a);this.pluginsManager.fireNodeInserted(a,b);this.endBatchChange(c);return!0},placeholdDeletes:function(){var a=this;this.isPlaceholdingDeletes&&this.revertDeletePlaceholders();
this.isPlaceholdingDeletes=!0;this._deletes=[];var b="."+this._getIceNodeClass("deleteType");ice.dom.each(ice.dom.find(this.element,b),function(b,d){a._deletes.push(ice.dom.cloneNode(d));ice.dom.replaceWith(d,"<"+a._delBookmark+' data-allocation="'+(a._deletes.length-1)+'"/>')});return!0},revertDeletePlaceholders:function(){var a=this;if(!this.isPlaceholdingDeletes)return!1;ice.dom.each(this._deletes,function(b,c){ice.dom.find(a.element,a._delBookmark+"[data-allocation="+b+"]").replaceWith(c)});this.isPlaceholdingDeletes=
!1;return!0},deleteContents:function(a,b){var c=!0;b?this.selection.addRange(b):b=this.getCurrentRange();var f=this.startBatchChange(this.changeTypes.deleteType.alias);b.collapsed===!1?this._deleteFromSelection(b):c=a?this._deleteFromRight(b):this._deleteFromLeft(b);this.selection.addRange(b);this.endBatchChange(f);return c},getChanges:function(){return this._changes},getElementContent:function(){return this.element.innerHTML},getCleanContent:function(a,b){var c="",f=this;ice.dom.each(this.changeTypes,
function(a,b){a!="deleteType"&&(b>0&&(c+=","),c+="."+f._getIceNodeClass(a))});var a=a?typeof a==="string"?ice.dom.create("<div>"+a+"</div>"):ice.dom.cloneNode(a)[0]:ice.dom.cloneNode(this.element)[0],g=ice.dom.find(a,c);ice.dom.each(g,function(){ice.dom.replaceWith(this,ice.dom.contents(this))});g=ice.dom.find(a,"."+this._getIceNodeClass("deleteType"));ice.dom.remove(g);a=b?b.call(this,a):a;return a.innerHTML},acceptAll:function(){this.element.innerHTML=this.getCleanContent()},rejectAll:function(){var a=
"."+this._getIceNodeClass("insertType"),b="."+this._getIceNodeClass("deleteType");ice.dom.remove(ice.dom.find(this.element,a));ice.dom.each(ice.dom.find(this.element,b),function(a,b){ice.dom.replaceWith(b,ice.dom.contents(b))})},acceptChange:function(a){this.acceptRejectChange(a,!0)},rejectChange:function(a){this.acceptRejectChange(a,!1)},acceptRejectChange:function(a,b){var c,f,g,h,j,n,l=ice.dom;if(!a)if(c=this.getCurrentRange(),c.collapsed)a=c.startContainer;else return;c=g="."+this._getIceNodeClass("deleteType");
f=h="."+this._getIceNodeClass("insertType");j=l.getNode(a,c+","+f);n=l.find(this.element,"["+this.changeIdAttribute+"="+l.attr(j,this.changeIdAttribute)+"]");b||(g=f,h=c);ice.dom.is(j,h)?l.each(n,function(a,b){l.replaceWith(b,ice.dom.contents(b))}):l.is(j,g)&&l.remove(n)},isInsideChange:function(a){var b="."+this._getIceNodeClass("insertType")+", ."+this._getIceNodeClass("deleteType");if(!a)if(range=this.getCurrentRange(),range.collapsed)a=range.startContainer;else return!1;return!!ice.dom.getNode(a,
b)},addChangeType:function(a,b,c){this.changeTypes[a]={tag:b,alias:c}},getIceNode:function(a,b){var c="."+this._getIceNodeClass(b);return ice.dom.getNode(a,c)},_moveRangeToValidTrackingPos:function(a){for(var b=!1,c=this._getVoidElement(a.endContainer);c;){try{a.moveEnd(ice.dom.CHARACTER_UNIT,1),a.moveEnd(ice.dom.CHARACTER_UNIT,-1)}catch(f){b=!0}if(b||ice.dom.onBlockBoundary(a.endContainer,a.startContainer,this.blockEl)){a.setStartAfter(c);a.collapse(!0);break}(c=this._getVoidElement(a.endContainer))?
(a.setEnd(a.endContainer,0),a.moveEnd(ice.dom.CHARACTER_UNIT,ice.dom.getNodeTextContent(a.endContainer).length),a.collapse()):(a.setStart(a.endContainer,0),a.collapse(!0))}},_getVoidElement:function(a){var b=this._getVoidElSelector();return ice.dom.is(a,b)?a:ice.dom.parents(a,b)[0]||null},_getVoidElSelector:function(){return"."+this._getIceNodeClass("deleteType")+","+this.avoid},_currentUserIceNode:function(a){return ice.dom.attr(a,this.userIdAttribute)==this.currentUser.id},_getChangeTypeFromAlias:function(a){var b,
c=null;for(b in this.changeTypes)this.changeTypes.hasOwnProperty(b)&&this.changeTypes[b].alias==a&&(c=b);return c},_getIceNodeClass:function(a){return this.attrValuePrefix+this.changeTypes[a].alias},getUserStyle:function(a){var b=null;return b=this._userStyles[a]?this._userStyles[a]:this.setUserStyle(a,this.getNewStyleId())},setUserStyle:function(a,b){var c=this.stylePrefix+"-"+b;this._styles[b]||(this._styles[b]=!0);return this._userStyles[a]=c},getNewStyleId:function(){var a=++this._uniqueStyleIndex;
return this._styles[a]?this.getNewStyleId():(this._styles[a]=!0,a)},addChange:function(a,b){var c=this._batchChangeid||this.getNewChangeId();this._changes[c]||(this._changes[c]={type:this._getChangeTypeFromAlias(a),time:(new Date).getTime(),userid:this.currentUser.id,username:this.currentUser.name});var f=this;ice.dom.foreach(b,function(a){f.addNodeToChange(c,b[a])});return c},addNodeToChange:function(a,b){if(this._batchChangeid!==null)a=this._batchChangeid;var c=this.getChange(a);b.getAttribute(this.changeIdAttribute)||
b.setAttribute(this.changeIdAttribute,a);b.getAttribute(this.userIdAttribute)||b.setAttribute(this.userIdAttribute,c.userid);b.getAttribute(this.userNameAttribute)||b.setAttribute(this.userNameAttribute,c.username);b.getAttribute(this.timeAttribute)||b.setAttribute(this.timeAttribute,c.time);ice.dom.hasClass(b,this._getIceNodeClass(c.type))||ice.dom.addClass(b,this._getIceNodeClass(c.type));c=this.getUserStyle(c.userid);ice.dom.hasClass(b,c)||ice.dom.addClass(b,c)},getChange:function(a){var b=null;
this._changes[a]&&(b=this._changes[a]);return b},getNewChangeId:function(){var a=++this._uniqueIDIndex;this._changes[a]&&(a=this.getNewChangeId());return a},startBatchChange:function(){return this._batchChangeid=this.getNewChangeId()},endBatchChange:function(a){if(a===this._batchChangeid)this._batchChangeid=null},getCurrentRange:function(){return this.selection.getRangeAt(0)},_insertNode:function(a,b,c){var f=this._currentUserIceNode(this.getIceNode(b.startContainer,"insertType"));if(!c||!f)f||(a=
this.createIceNode("insertType",a)),b.insertNode(a),c&&(b.setStart(a,0),b.setEnd(a,1)),this.selection.addRange(b)},_deleteFromSelection:function(a){for(var b=new ice.Bookmark(a),c=ice.dom.getElementsBetween(b.start,b.end),f=ice.dom.parents(a.startContainer,this.blockEl)[0],g=ice.dom.parents(a.endContainer,this.blockEl)[0],h=[],j=c.length,n=0;n<j;n++){var l=c[n];ice.dom.is(l,this.blockEl)&&h.push(l);if(!(l.nodeType===ice.dom.TEXT_NODE&&ice.dom.getNodeTextContent(l)==="")&&!this._getVoidElement(l)){if(l.nodeType!==
ice.dom.TEXT_NODE){ice.dom.remove(ice.dom.find(l,"br"));var s=ice.dom.cloneNode(l);ice.dom.remove(ice.dom.find(s,this._getVoidElSelector()));if(ice.dom.getNodeTextContent(s).length===0)continue;else if(ice.dom.is(l,this.blockEl)){s=this.createIceNode("deleteType");newEl=document.createElement(this.blockEl);s.innerHTML=l.innerHTML;l.innerHTML="";l.appendChild(s);continue}}s=this.createIceNode("deleteType");ice.dom.insertBefore(l,s);s.appendChild(l)}}if(f!==g){for(;h.length;)ice.dom.mergeContainers(h.shift(),
f);ice.dom.mergeContainers(g,f)}(c=b.start.previousSibling)?(b.selectBookmark(),a=this.getCurrentRange(),a.moveStart(ice.dom.CHARACTER_UNIT,-1),a.moveStart(ice.dom.CHARACTER_UNIT,1)):(c=ice.env.document.createTextNode(""),ice.dom.insertBefore(b.start,c),this.selection.addRange(a),b.selectBookmark(),a=this.getCurrentRange(),a.setStart(c,0));a.collapse(!0)},_deleteFromRight:function(a){var b=ice.dom.parents(a.startContainer,this.blockEl)[0]||ice.dom.is(a.startContainer,this.blockEl)&&a.startContainer||
null,c=b&&b.nextSibling||null,f=ice.dom.is(a.startContainer,this.blockEl)&&ice.dom.getNodeTextContent(a.startContainer)=="";a.moveEnd(ice.dom.CHARACTER_UNIT,1);a.moveEnd(ice.dom.CHARACTER_UNIT,-1);if(!c&&!ice.dom.isChildOf(a.endContainer,this.element))return a.moveEnd(ice.dom.CHARACTER_UNIT,-1),a.moveEnd(ice.dom.CHARACTER_UNIT,1),a.collapse(),!0;if(ice.dom.onBlockBoundary(a.endContainer,a.startContainer,this.blockEl)||f)return c!==ice.dom.parents(a.endContainer,this.blockEl)[0]&&a.setEnd(c,0),ice.dom.remove(ice.dom.find(a.startContainer,
"br")),ice.dom.mergeBlockWithSibling(a,ice.dom.parents(a.startContainer,this.blockEl)[0]||b,!0);if(this._getVoidElement(a.endContainer))return a.setEnd(a.endContainer,0),a.moveEnd(ice.dom.CHARACTER_UNIT,ice.dom.getNodeTextContent(a.endContainer).length||0),a.collapse(),this._deleteFromRight(a);a.collapse();b=a.startContainer;if(a.startContainer.data&&a.endOffset===b.data.length){c=a.cloneRange();c.moveEnd(ice.dom.CHARACTER_UNIT,1);if(f=ice.dom.getBlockParent(c.endContainer,this.element)){if(ice.dom.isChildOf(f,
this.element)===!1)return;var g=ice.dom.getBlockParent(c.startContainer,this.element);if(f!==g){ice.dom.mergeContainers(f,g);a.setStart(c.startContainer,c.startContainer.data.length);a.collapse(!0);return}}b=a.getNextContainer(b);if(ice.dom.isChildOf(b,this.element)===!1)return!1;b=a.getFirstSelectableChild(b);a.setStart(b,0);this._addTextNodeTracking(b,a)}else if(b=this.getIceNode(a.startContainer,"insertType"),b===null||!this._currentUserIceNode(b))this._addTextNodeTracking(a.startContainer,a,!0);
else if(a.moveEnd(ice.dom.CHARACTER_UNIT,1),a.deleteContents(),b!==null&&ice.dom.isBlank(ice.dom.getNodeTextContent(b))===!0){c=b.previousSibling;if(!c||c.nodeType!==ice.dom.TEXT_NODE)c=ice.env.document.createTextNode(""),ice.dom.insertBefore(b,c);a.setStart(c,c.data.length);ice.dom.remove(b)}a.collapse(!0);return!0},_deleteFromLeft:function(a){var b=ice.dom.parents(a.startContainer,this.blockEl)[0]||ice.dom.is(a.startContainer,this.blockEl)&&a.startContainer||null,c=b&&b.previousSibling||null,f=
ice.dom.is(a.startContainer,this.blockEl)&&ice.dom.getNodeTextContent(a.startContainer)=="";a.moveStart(ice.dom.CHARACTER_UNIT,-1);var g=a.startOffset===a.endOffset&&a.startContainer===a.endContainer,h=!ice.dom.isChildOf(a.startContainer,this.element);a.moveStart(ice.dom.CHARACTER_UNIT,1);if(g||!c&&h)return a.moveStart(ice.dom.CHARACTER_UNIT,1),a.moveStart(ice.dom.CHARACTER_UNIT,-1),a.collapse(!0),!0;if(ice.dom.onBlockBoundary(a.startContainer,a.endContainer,this.blockEl)||f)return c!==ice.dom.parents(a.startContainer,
this.blockEl)[0]&&a.setStart(c,0),ice.dom.remove(ice.dom.find(a.endContainer,"br")),ice.dom.mergeBlockWithSibling(a,ice.dom.parents(a.endContainer,this.blockEl)[0]||b);if(this._getVoidElement(a.startContainer))return a.setStart(a.startContainer,0),a.collapse(!0),this._deleteFromLeft(a);b=a.startContainer;if(a.startOffset===0){c=a.cloneRange();c.moveStart(ice.dom.CHARACTER_UNIT,-1);if(f=ice.dom.getBlockParent(c.startContainer,this.element)){if(ice.dom.isChildOf(f,this.element)===!1)return!1;g=ice.dom.getBlockParent(c.endContainer,
this.element);if(g!==f){ice.dom.mergeContainers(g,f);a.setStart(c.startContainer,c.startContainer.data.length);a.collapse(!0);return}}b=a.getPreviousContainer(b);if(!ice.dom.isChildOf(b,this.element))return!1;ice.dom.isStubElement(b)?(a.moveStart(ice.dom.CHARACTER_UNIT,-1),ice.dom.addClass(b,this._getIceNodeClass("deleteType")),ice.dom.attr(b,"title","Content removed"),a.collapse(!0)):(b=a.getLastSelectableChild(b),a.setStart(b,b.data.length),this._addTextNodeTracking(b,a))}else c=a.startContainer,
b=this.getIceNode(c,"insertType"),b===null||!this._currentUserIceNode(b)?this._addTextNodeTracking(c,a):(a.moveStart(ice.dom.CHARACTER_UNIT,-1),a.moveEnd(ice.dom.CHARACTER_UNIT,-1),a.moveEnd(ice.dom.CHARACTER_UNIT,1),a.deleteContents(),b!==null&&ice.dom.isBlank(ice.dom.getNodeTextContent(b))&&(c=ice.env.document.createTextNode(""),ice.dom.insertBefore(b,c),a.setStart(c,0),a.collapse(!0),ice.dom.replaceWith(b,ice.dom.contents(b))));return!0},_addTextNodeTracking:function(a,b,c){if(!(!c&&b.startOffset===
0||this.getIceNode(a,"deleteType")!==null)){var f="",g="",h="";c?(f=a.nodeValue.substring(0,b.endOffset),g=a.nodeValue.substr(b.endOffset,1),h=a.nodeValue.substring(b.endOffset+1)):(f=a.nodeValue.substring(0,b.startOffset-1),g=a.nodeValue.substr(b.startOffset-1,1),h=a.nodeValue.substring(b.startOffset));if(b.startOffset===1&&!c||c&&b.startOffset===0){var j=this.getIceNode(a.previousSibling,"deleteType");j!==null&&!this._currentUserIceNode(j)&&(j=null);if(j){if(c)if(j.lastChild&&j.lastChild.nodeType===
ice.dom.TEXT_NODE?j.lastChild.nodeValue+=g:(c=ice.env.document.createTextNode(g),j.appendChild(c)),a.nodeValue=f+h,a.nodeValue.length===0){c=!1;for(a=a.nextSibling;!c;)(j=this.getIceNode(a,"deleteType"))?a=a.nextSibling:c=!0;a&&(b.setStart(a,0),b.collapse(!0))}else b.setStart(a,0),b.collapse(!0);else if(j.lastChild&&j.lastChild.nodeType===ice.dom.TEXT_NODE?(j.lastChild.nodeValue+=g,b.setStart(j.lastChild,j.lastChild.nodeValue.length-1)):(c=ice.env.document.createTextNode(g),j.appendChild(c),b.setStart(c,
0)),a.nodeValue=f+h,a.nodeValue=f+h,a.nodeValue.length===0){c=!1;for(a=a.previousSibling;!c;)(j=this.getIceNode(a,"deleteType"))?a=a.previousSibling:c=!0;a&&(a=b.getLastSelectableChild(a),b.setStart(a,a.nodeValue.length),b.collapse(!0))}else b.collapse(!0);return}}if(b.startOffset===a.nodeValue.length&&(j=this.getIceNode(a.nextSibling,"deleteType"),j!==null&&!this._currentUserIceNode(j)&&(j=null),j)){j.firstChild&&j.firstChild.nodeType===ice.dom.TEXT_NODE?j.firstChild.nodeValue=g+j.firstChild.nodeValue:
(c=ice.env.document.createTextNode(g),ice.dom.insertBefore(j.firstChild,c));a.nodeValue=f;b.setStart(a,a.nodeValue.length);b.setEnd(a,a.nodeValue.length);return}j=this.createIceNode("deleteType");f=null;c!==!0?(f=a.splitText(b.startOffset-1),f.nodeValue=f.nodeValue.substring(1),ice.dom.insertAfter(a,f),j.firstChild.nodeValue=g,ice.dom.insertAfter(a,j),b.setStart(a,a.nodeValue.length),b.setEnd(a,a.nodeValue.length)):(f=a.splitText(b.endOffset),f.nodeValue=f.nodeValue.substring(1),ice.dom.insertAfter(a,
f),j.firstChild.nodeValue=g,ice.dom.insertAfter(a,j),b.setStart(f,0),b.setEnd(f,0))}},_handleAncillaryKey:function(a){var b=!0;switch(a.keyCode){case ice.dom.DOM_VK_DELETE:b=this.deleteContents();this.pluginsManager.fireKeyPressed(a);break;case 46:b=this.deleteContents(!0);this.pluginsManager.fireKeyPressed(a);break;case ice.dom.DOM_VK_DOWN:case ice.dom.DOM_VK_UP:case ice.dom.DOM_VK_LEFT:case ice.dom.DOM_VK_RIGHT:this.pluginsManager.fireCaretPositioned();b=!1;break;default:b=!1}return b===!0?(ice.dom.preventDefault(a),
!1):!0},keyDown:function(a){if(!this.pluginsManager.fireKeyDown(a))return ice.dom.preventDefault(a),!1;var b=!1;if(this._handleSpecialKey(a)===!1){if(ice.dom.isBrowser("msie")!==!0)this._preventKeyPress=!0;return!1}else if((a.ctrlKey===!0||a.metaKey===!0)&&(ice.dom.isBrowser("msie")===!0||ice.dom.isBrowser("chrome")===!0)&&!this.pluginsManager.fireKeyPressed(a))return!1;switch(a.keyCode){case 27:break;default:/Firefox/.test(navigator.userAgent)!==!0&&(b=!this._handleAncillaryKey(a))}return b?(ice.dom.preventDefault(a),
!1):!0},keyPress:function(a){if(this._preventKeyPress===!0)this._preventKeyPress=!1;else{if(!this.pluginsManager.fireKeyPressed(a))return!1;var b=null;a.which==null?b=String.fromCharCode(a.keyCode):a.which>0&&(b=String.fromCharCode(a.which));var c=this.getCurrentRange(),f=ice.dom.parents(c.startContainer,"br")[0]||null;f&&(c.moveToNextEl(f),f.parentNode.removeChild(f));if(b!==null&&a.ctrlKey!==!0&&a.metaKey!==!0)switch(a.keyCode){case ice.dom.DOM_VK_DELETE:break;case ice.dom.DOM_VK_ENTER:return this._handleEnter();
default:return this._moveRangeToValidTrackingPos(c,c.startContainer),this.insert()}return this._handleAncillaryKey(a)}},_handleEnter:function(){this.getCurrentRange().collapsed||this.deleteContents();return!0},_handleSpecialKey:function(a){var b=a.which;if(b===null)b=a.keyCode;var c=!1;switch(b){case 65:if(a.ctrlKey===!0||a.metaKey===!0){c=!0;b=this.getCurrentRange();if(ice.dom.isBrowser("msie")===!0){var f=ice.env.document.createTextNode(""),g=ice.env.document.createTextNode("");this.element.firstChild?
ice.dom.insertBefore(this.element.firstChild,f):this.element.appendChild(f);this.element.appendChild(g);b.setStart(f,0);b.setEnd(g,0)}else b.setStart(b.getFirstSelectableChild(this.element),0),f=b.getLastSelectableChild(this.element),b.setEnd(f,f.length);this.selection.addRange(b)}}return c===!0?(ice.dom.preventDefault(a),!1):!0},mouseUp:function(a){if(!this.pluginsManager.fireClicked(a))return!1;this.pluginsManager.fireSelectionChanged(this.getCurrentRange())},mouseDown:function(a){if(!this.pluginsManager.fireMouseDown(a))return!1;
this.pluginsManager.fireCaretUpdated()}};this.ice=this.ice||{};this.ice.InlineChangeEditor=b}).call(this);
(function(){var c={DOM_VK_DELETE:8,DOM_VK_LEFT:37,DOM_VK_UP:38,DOM_VK_RIGHT:39,DOM_VK_DOWN:40,DOM_VK_ENTER:13,ELEMENT_NODE:1,ATTRIBUTE_NODE:2,TEXT_NODE:3,CDATA_SECTION_NODE:4,ENTITY_REFERENCE_NODE:5,ENTITY_NODE:6,PROCESSING_INSTRUCTION_NODE:7,COMMENT_NODE:8,DOCUMENT_NODE:9,DOCUMENT_TYPE_NODE:10,DOCUMENT_FRAGMENT_NODE:11,NOTATION_NODE:12,CHARACTER_UNIT:"character",WORD_UNIT:"word",getKeyChar:function(b){return String.fromCharCode(b.which)},getClass:function(b,a,c){if(!a)a=document.body;b="."+b.split(" ").join(".");
c&&(b=c+b);return jQuery.makeArray(jQuery(a).find(b))},getId:function(b,a){a||(a=document);return element=a.getElementById(b)},getTag:function(b,a){a||(a=document);return jQuery.makeArray(jQuery(a).find(b))},getElementWidth:function(b){return b.offsetWidth},getElementHeight:function(b){return b.offsetHeight},getElementDimensions:function(b){return{width:c.getElementWidth(b),height:c.getElementHeight(b)}},ready:function(b,a){jQuery(b).ready(a)},trim:function(b){return jQuery.trim(b)},empty:function(b){if(b)return jQuery(b).empty()},
remove:function(b){if(b)return jQuery(b).remove()},prepend:function(b,a){jQuery(b).prepend(a)},append:function(b,a){jQuery(b).append(a)},insertBefore:function(b,a){jQuery(b).before(a)},insertAfter:function(b,a){jQuery(b).after(a)},getHtml:function(b){return jQuery(b).html()},setHtml:function(b,a){b&&jQuery(b).html(a)},contents:function(b){return jQuery(b).contents()},extractContent:function(b){for(var a=document.createDocumentFragment(),c;c=b.firstChild;)a.appendChild(c);return a}};c.getNode=function(b,
a){return c.is(b,a)?b:c.parents(b,a)[0]||null};c.getParents=function(b,a,c){for(var b=jQuery(b).parents(a),a=b.length,e=[],f=0;f<a;f++){if(b[f]===c)break;e.push(b[f])}return e};c.hasBlockChildren=function(b){for(var a=b.childNodes.length,d=0;d<a;d++)if(b.childNodes[d].nodeType===c.ELEMENT_NODE&&c.isBlockElement(b.childNodes[d])===!0)return!0;return!1};c.removeTag=function(b,a){jQuery(b).find(a).replaceWith(function(){return jQuery(this).contents()});return b};c.stripEnclosingTags=function(b,a){var c=
jQuery(b);c.find("*").not(a).replaceWith(function(){return jQuery(this).contents()});return c[0]};c.getSiblings=function(b,a,c,e){if(c===!0)return a==="prev"?jQuery(b).prevAll():jQuery(b).nextAll();else{c=[];if(a==="prev")for(;b.previousSibling;){b=b.previousSibling;if(b===e)break;c.push(b)}else for(;b.nextSibling;){b=b.nextSibling;if(b===e)break;c.push(b)}return c}};c.normalize=function(b){if(c.isBlockElement(b)===!0)return!1;for(;b.nextSibling;){var a=b.nextSibling;if(b.nodeType===c.TEXT_NODE)if(a.nodeType===
c.TEXT_NODE)c.remove(a),b.nodeValue+=a.nodeValue;else break;else if(b.tagName===a.tagName){c.remove(a);for(var d=a.childNodes.length;d>0;)b.appendChild(a.firstChild),d=a.childNodes.length}else break}for(;b.previousSibling;)if(a=b.previousSibling,b.nodeType===c.TEXT_NODE)if(a.nodeType===c.TEXT_NODE)c.remove(b),a.nodeValue+=b.nodeValue,b=a;else break;else if(b.tagName===a.tagName){c.remove(b);for(d=b.childNodes.length;d>0;)a.appendChild(b.firstChild),d=b.childNodes.length;b=a}else break};c.normalizeChildren=
function(b){if(b.nodeType!==c.ELEMENT_NODE)return!1;for(var a=b.childNodes.length,d=0;d<a;d++){var e=b.childNodes[d];e&&(e.nodeType!==c.TEXT_NODE&&c.normalizeChildren(e),c.normalize(e))}};c.getNodeTextContent=function(b){return jQuery(b).text()};c.setNodeTextContent=function(b,a){return jQuery(b).text(a)};c.getTagName=function(b){return b.tagName&&b.tagName.toLowerCase()||null};c.getIframeDocument=function(b){var a=null;if(b.contentDocument)a=b.contentDocument;else if(b.contentWindow)a=b.contentWindow.document;
else if(b.document)a=b.document;return a};c.isBlockElement=function(b){switch(b.nodeName.toLowerCase()){case "p":case "div":case "pre":case "ul":case "ol":case "li":case "table":case "tbody":case "td":case "th":case "fieldset":case "form":case "blockquote":case "dl":case "dir":case "center":case "address":case "h1":case "h2":case "h3":case "h4":case "h5":case "h6":case "img":return!0;default:return!1}};c.isStubElement=function(b){if(b)switch(b.nodeName.toLowerCase()){case "img":case "br":case "hr":case "iframe":case "param":case "link":case "meta":case "input":case "frame":case "col":case "base":case "area":return!0}return!1};
c.isChildOf=function(b,a){try{for(;b&&b.parentNode;){if(b.parentNode===a)return!0;b=b.parentNode}}catch(c){}return!1};c.isChildOfTagName=function(b,a){var c=null;try{for(;b&&b.parentNode;){if(b.parentNode&&b.parentNode.tagName&&b.parentNode.tagName.toLowerCase()===a)c=b.parentNode;b=b.parentNode}}catch(e){}return c};c.isChildOfClassName=function(b,a){var c=null;try{for(;b&&b.parentNode;){if(jQuery(b.parentNode).hasClass(a))c=b.parentNode;b=b.parentNode}}catch(e){}return c};c.cloneNode=function(b,
a){a===void 0&&(a=!0);return jQuery(b).clone(a)};c.bind=function(b,a,c){return jQuery(b).bind(a,c)};c.attr=function(b,a,c){return c?jQuery(b).attr(a,c):jQuery(b).attr(a)};c.replaceWith=function(b,a){return jQuery(b).replaceWith(a)};c.removeAttr=function(b,a){jQuery(b).removeAttr(a)};c.getElementsBetween=function(b,a){var d=[];if(b===a)return d;if(c.isChildOf(a,b)===!0){for(var e=b.childNodes.length,f=0;f<e;f++)if(b.childNodes[f]===a)break;else if(c.isChildOf(a,b.childNodes[f])===!0)return c.arrayMerge(d,
c.getElementsBetween(b.childNodes[f],a));else d.push(b.childNodes[f]);return d}for(e=b.nextSibling;e;)if(c.isChildOf(a,e)===!0)return d=c.arrayMerge(d,c.getElementsBetween(e,a));else if(e===a)return d;else d.push(e),e=e.nextSibling;for(var e=c.getParents(b),f=c.getParents(a),e=c.arrayDiff(e,f,!0),f=e.length,g=0;g<f-1;g++)d=c.arrayMerge(d,c.getSiblings(e[g],"next"));return d=c.arrayMerge(d,c.getElementsBetween(e[e.length-1],a))};c.getCommonAncestor=function(b,a){for(var d=b;d;){if(c.isChildOf(a,d)===
!0)return d;d=d.parentNode}return null};c.getNextNode=function(b){if(b.nextSibling)return b.nextSibling;else if(b.parentNode)return c.getFirstChild(b.parentNode);return null};c.getPrevNode=function(b){if(b.previousSibling)return b.previousSibling;else if(b.parentNode)return c.getLastChild(b.parentNode);return null};c.getFirstChild=function(b){return b.firstChild?b.firstChild.nodeType===c.ELEMENT_NODE?c.getFirstChild(b.firstChild):b.firstChild:b};c.getLastChild=function(b){return b.lastChild?b.lastChild.nodeType===
c.ELEMENT_NODE?c.getLastChild(b.lastChild):b.lastChild:b};c.removeEmptyNodes=function(b,a){for(var d=jQuery(b).find(":empty"),e=d.length;e>0;)e--,c.isStubElement(d[e])===!1&&(!a||a.call(this,d[e])!==!1)&&c.remove(d[e])};c.create=function(b){return jQuery(b)[0]};c.find=function(b,a){return jQuery(b).find(a)};c.children=function(b,a){return jQuery(b).children(a)};c.parent=function(b,a){return jQuery(b).parent(a)[0]};c.parents=function(b,a){return jQuery(b).parents(a)};c.is=function(b,a){return jQuery(b).is(a)};
c.extend=function(b,a,c,e){return jQuery.extend.apply(this,arguments)};c.getTextNodes=function(b,a){var d=[];if(b&&b.childNodes)for(var e=b.childNodes.length,f=0;f<e;f++){var g=b.childNodes[f];g.nodeType===c.TEXT_NODE?a===!0&&/^\s*$/.test(g.data)===!0?c.remove(g):d.push(g):g.childNodes&&g.childNodes.length>0&&(d=d.concat(c.getTextNodes(g)))}return d};c.getFirstBlockParent=function(b,a){for(;b.parentNode;){b=b.parentNode;if(a&&b===a)break;if(c.isBlockElement(b)===!0)return b}return null};c.walk=function(b,
a,d){b&&(d||(d=0),a.call(this,b,d)!==!1&&(b.childNodes&&b.childNodes.length>0?c.walk(b.firstChild,a,d+1):b.nextSibling?c.walk(b.nextSibling,a,d):b.parentNode&&b.parentNode.nextSibling&&c.walk(b.parentNode.nextSibling,a,d-1)))};c.revWalk=function(b,a){b&&a.call(this,b)!==!1&&(b.childNodes&&b.childNodes.length>0?c.walk(b.lastChild,a):b.previousSibling?c.walk(b.previousSibling,a):b.parentNode&&b.parentNode.previousSibling&&c.walk(b.parentNode.previousSibling,a))};c.setStyle=function(b,a,c){b&&jQuery(b).css(a,
c)};c.getStyle=function(b,a){return jQuery(b).css(a)};c.hasClass=function(b,a){return jQuery(b).hasClass(a)};c.addClass=function(b,a){jQuery(b).addClass(a)};c.removeClass=function(b,a){jQuery(b).removeClass(a)};c.preventDefault=function(b){b.preventDefault();c.stopPropagation(b)};c.stopPropagation=function(b){b.stopPropagation()};c.noInclusionInherits=function(b,a){if(a instanceof String||typeof a==="string")a=window[a];if(b instanceof String||typeof b==="string")b=window[b];var d=function(){};if(c.isset(a)===
!0)for(value in a.prototype)b.prototype[value]?d.prototype[value]=a.prototype[value]:b.prototype[value]=a.prototype[value];if(b.prototype)d.prototype.constructor=a,b.prototype["super"]=new d};c.each=function(b,a){jQuery.each(b,function(b,c){a.call(this,b,c)})};c.foreach=function(b,a){if(b instanceof Array||b instanceof NodeList||typeof b.length!="undefined"&&typeof b.item!="undefined")for(var c=b.length,e=0;e<c;e++){var f=a.call(this,e,b[e]);if(f===!1)break}else for(c in b)if(b.hasOwnProperty(c)===
!0&&(f=a.call(this,c),f===!1))break};c.isBlank=function(b){return!b||/^\s*$/.test(b)?!0:!1};c.isFn=function(b){return typeof b==="function"?!0:!1};c.isObj=function(b){return b!==null&&typeof b==="object"?!0:!1};c.isset=function(b){return typeof b!=="undefined"&&b!==null?!0:!1};c.isArray=function(b){return jQuery.isArray(b)};c.isNumeric=function(b){return b.match(/^\d+$/)!==null?!0:!1};c.getUniqueId=function(){return((new Date).getTime()+""+Math.ceil(Math.random()*1E6)).substr(5,18).replace(/,/,"")};
c.inArray=function(b,a){for(var c=a.length,e=0;e<c;e++)if(b===a[e])return!0;return!1};c.arrayDiff=function(b,a,d){for(var e=b.length,f=[],g=0;g<e;g++)c.inArray(b[g],a)===!1&&f.push(b[g]);if(d!==!0){e=a.length;for(g=0;g<e;g++)c.inArray(a[g],b)===!1&&f.push(a[g])}return f};c.arrayMerge=function(b,a){for(var c=a.length,e=0;e<c;e++)b.push(a[e]);return b};c.removeArrayIndex=function(b,a){return!b||c.isset(b[a])===!1?null:b.splice(a,1)};c.stripTags=function(b,a){if(typeof a==="string"){var d=jQuery("<div>"+
b+"</div>");d.find("*").not(a).remove();return d.html()}else{for(var e=RegExp(/<\/?(\w+)((\s+\w+(\s*=\s*(?:".*?"|'.*?'|[^'">\s]+))?)+\s*|\s*)\/?>/gim),f=b;(d=e.exec(b))!=null;)if(c.isset(a)===!1||c.inArray(d[1],a)!==!0)f=f.replace(d[0],"");return f}};c.browser=function(){var b={};b.version=jQuery.browser.version;if(jQuery.browser.mozilla===!0)b.type="mozilla";else if(jQuery.browser.msie===!0)b.type="msie";else if(jQuery.browser.opera===!0)b.type="opera";else if(jQuery.browser.safari===!0)b.type="safari";
return b};c.getBrowserType=function(){if(this._browserType===null){for(var b=["msie","firefox","chrome","safari"],a=b.length,c=0;c<a;c++)if(RegExp(b[c],"i").test(navigator.userAgent)===!0)return this._browserType=b[c];this._browserType="other"}return this._browserType};c.isBrowser=function(b){return c.browser().type===b};c.getBlockParent=function(b,a){if(b)for(;b.parentNode;){b=b.parentNode;if(b===a)break;if(c.isBlockElement(b)===!0)return b}return null};c.onBlockBoundary=function(b,a,d){if(!b||!a)return!1;
b=c.isChildOfTagName(b,d)||c.is(b,d)&&b||null;a=c.isChildOfTagName(a,d)||c.is(a,d)&&a||null;return b!==a};c.mergeContainers=function(b,a){if(!b||!a)return!1;if(b.nodeType===c.TEXT_NODE||c.isStubElement(b))a.appendChild(b);else if(b.nodeType===c.ELEMENT_NODE){for(;b.firstChild;)a.appendChild(b.firstChild);c.remove(b)}return!0};c.mergeBlockWithSibling=function(b,a,d){var e=d?a.nextSibling:a.previousSibling;d?c.mergeContainers(e,a):c.mergeContainers(a,e);b.collapse(!0);return!0};c.date=function(b,a,
d){if(a===null&&d&&(a=c.tsIso8601ToTimestamp(d),!a))return;for(var a=new Date(a),b=b.split(""),d=b.length,e="",f=0;f<d;f++){var g="",h=b[f];switch(h){case "D":case "l":g=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"][a.getDay()];h==="D"&&(g=g.substring(0,3));break;case "F":case "m":g=a.getMonth()+1;g<10&&(g="0"+g);break;case "M":months=["January","February","March","April","May","June","July","August","September","October","November","December"];g=months[a.getMonth()];h===
"M"&&(g=g.substring(0,3));break;case "d":g=a.getDate();break;case "S":g=c.getOrdinalSuffix(a.getDate());break;case "Y":g=a.getFullYear();break;case "y":g=a.getFullYear();g=g.toString().substring(2);break;case "H":g=a.getHours();break;case "h":g=a.getHours();g===0?g=12:g>12&&(g-=12);break;case "i":g=c.addNumberPadding(a.getMinutes());break;case "a":g="am";a.getHours()>=12&&(g="pm");break;default:g=h}e+=g}return e};c.getOrdinalSuffix=function(b){var a="",a=b%100;if(a>=4&&a<=20)a="th";else switch(b%
10){case 1:a="st";break;case 2:a="nd";break;case 3:a="rd";break;default:a="th"}return a};c.addNumberPadding=function(b){b<10&&(b="0"+b);return b};c.tsIso8601ToTimestamp=function(b){if(b=b.match(RegExp(/(\d\d\d\d)(?:-?(\d\d)(?:-?(\d\d)(?:[T ](\d\d)(?::?(\d\d)(?::?(\d\d)(?:\.(\d+))?)?)?(?:Z|(?:([-+])(\d\d)(?::?(\d\d))?)?)?)?)?)?/))){var a=new Date;a.setDate(b[3]);a.setFullYear(b[1]);a.setMonth(b[2]-1);a.setHours(b[4]);a.setMinutes(b[5]);a.setSeconds(b[6]);var c=b[9]*60;b[8]==="+"&&(c*=-1);c-=a.getTimezoneOffset();
return a.getTime()+c*6E4}return null};this.ice.dom=c}).call(this);
(function(){var c;c=function(b,a){this.element=ice.env.element;this.selection=ice.env.selection;a||this.removeBookmarks(this.element);var c=b||this.selection.getRangeAt(0),b=c.cloneRange(),e=b.startContainer,f=b.startOffset;b.collapse(!1);var g=ice.env.document.createElement("span");g.style.display="none";ice.dom.setHtml(g,"&nbsp;");ice.dom.addClass(g,"iceBookmark iceBookmark_end");g.setAttribute("iceBookmark","end");b.insertNode(g);ice.dom.isChildOf(g,this.element)||this.element.appendChild(g);b.setStart(e,
f);b.collapse(!0);e=ice.env.document.createElement("span");e.style.display="none";ice.dom.addClass(e,"iceBookmark iceBookmark_start");ice.dom.setHtml(e,"&nbsp;");e.setAttribute("iceBookmark","start");try{b.insertNode(e),e.previousSibling===g&&(f=e,e=g,g=f)}catch(h){ice.dom.insertBefore(g,e)}ice.dom.isChildOf(e,this.element)===!1&&(this.element.firstChild?ice.dom.insertBefore(this.element.firstChild,e):this.element.appendChild(e));g.previousSibling||(f=ice.env.document.createTextNode(""),ice.dom.insertBefore(g,
f));e.nextSibling||(f=ice.env.document.createTextNode(""),ice.dom.insertAfter(e,f));c.setStart(e.nextSibling,0);c.setEnd(g.previousSibling,g.previousSibling.length||0);this.start=e;this.end=g};c.prototype={selectBookmark:function(){var b=this.selection.getRangeAt(0),a=null,c=null,e=0,f=null;if(this.start.nextSibling===this.end||ice.dom.getElementsBetween(this.start,this.end).length===0)if(this.end.nextSibling)a=ice.dom.getFirstChild(this.end.nextSibling);else if(this.start.previousSibling){if(a=ice.dom.getFirstChild(this.start.previousSibling),
a.nodeType===ice.dom.TEXT_NODE)e=a.length}else this.end.parentNode.appendChild(ice.env.document.createTextNode("")),a=ice.dom.getFirstChild(this.end.nextSibling);else this.start.nextSibling?a=ice.dom.getFirstChild(this.start.nextSibling):(this.start.previousSibling||(a=ice.env.document.createTextNode(""),ice.dom.insertBefore(this.start,a)),a=ice.dom.getLastChild(this.start.previousSibling),e=a.length),this.end.previousSibling?c=ice.dom.getLastChild(this.end.previousSibling):(c=ice.dom.getFirstChild(this.end.nextSibling),
f=0);ice.dom.remove([this.start,this.end]);c===null?(b.setEnd(a,e),b.collapse(!1)):(b.setStart(a,e),f===null&&(f=c.length||0),b.setEnd(c,f));try{this.selection.addRange(b)}catch(g){}},getBookmark:function(b,a){return ice.dom.getClass("iceBookmark_"+a,b)[0]},removeBookmarks:function(b){ice.dom.remove(ice.dom.getClass("iceBookmark",b,"span"))}};this.ice.Bookmark=c}).call(this);
(function(){var c;c=function(){this._selection=null;this._selection=ice.env.frame?rangy.getIframeSelection(ice.env.frame):rangy.getSelection()};c.prototype={_getSelection:function(){this._selection?this._selection.refresh():this._selection=ice.env.frame?rangy.getIframeSelection(ice.env.frame):rangy.getSelection();return this._selection},createRange:function(){return rangy.createRange(ice.env.document)},getRangeAt:function(b){this._selection.refresh();try{return this._selection.getRangeAt(b)}catch(a){return this.createRange()}},
addRange:function(b){this._selection=this._selection||this._getSelection();this._selection.setSingleRange(b);this._selection.ranges=[b]}};this.ice.Selection=c}).call(this);
(function(){this.ice.dom.ready(document,function(){rangy.init();rangy.config.checkSelectionRanges=!1;rangy.rangePrototype.moveStart=function(c,b){if(b===0)throw Error("InvalidArgumentException: units cannot be 0");switch(c){case ice.dom.CHARACTER_UNIT:b>0?this.moveCharRight(!0,b):this.moveCharLeft(!0,b)}};rangy.rangePrototype.moveEnd=function(c,b){if(b===0)throw Error("InvalidArgumentException: units cannot be 0");switch(c){case ice.dom.CHARACTER_UNIT:b>0?this.moveCharRight(!1,b):this.moveCharLeft(!1,
b)}};rangy.rangePrototype.setRange=function(c,b,a){c?this.setStart(b,a):this.setEnd(b,a)};rangy.rangePrototype.moveCharLeft=function(c,b){var a,d;c?(a=this.startContainer,d=this.startOffset):(a=this.endContainer,d=this.endOffset);d+=b;if(d<0)for(;d<0;){var e=[];if(!this.getPreviousContainer(a,e)){if(b===-1)return;d=0;break}a=this.getPreviousContainer(a,e);if(a.nodeType!==ice.dom.ELEMENT_NODE)d=a.data.length,d--}this.setRange(c,a,d)};rangy.rangePrototype.moveCharRight=function(c,b){var a,d;c?(a=this.startContainer,
d=this.startOffset):(a=this.endContainer,d=this.endOffset);a.nodeType===ice.dom.ELEMENT_NODE?(a=a.childNodes[d],a.nodeType!==ice.dom.TEXT_NODE&&(a=this.getNextTextNode(a)),d=b):d+=b;var e=d-a.data.length;if(e>0){for(d=[];e>0;)if(a=this.getNextContainer(a,d),a.nodeType!==ice.dom.ELEMENT_NODE)if(a.data.length>=e)break;else a.data.length>0&&(e-=a.data.length);d=e}this.setRange(c,a,d)};rangy.rangePrototype.getNextContainer=function(c,b){if(!c)return null;for(;c.nextSibling;)if(c=c.nextSibling,c.nodeType!==
ice.dom.TEXT_NODE){var a=this.getFirstSelectableChild(c);if(a!==null)return a}else if(this.isSelectable(c)===!0)return c;for(;c&&!c.nextSibling;)c=c.parentNode;if(!c)return null;c=c.nextSibling;if(this.isSelectable(c)===!0)return c;else b&&ice.dom.isBlockElement(c)===!0&&b.push(c);a=this.getFirstSelectableChild(c);return a!==null?a:this.getNextContainer(c,b)};rangy.rangePrototype.getPreviousContainer=function(c,b){if(!c)return null;for(;c.previousSibling;)if(c=c.previousSibling,c.nodeType!==ice.dom.TEXT_NODE)if(ice.dom.isStubElement(c)===
!0)return c;else{var a=this.getLastSelectableChild(c);if(a!==null)return a}else if(this.isSelectable(c)===!0)return c;for(;c&&!c.previousSibling;)c=c.parentNode;if(!c)return null;c=c.previousSibling;if(this.isSelectable(c)===!0)return c;else b&&ice.dom.isBlockElement(c)===!0&&b.push(c);a=this.getLastSelectableChild(c);return a!==null?a:this.getPreviousContainer(c,b)};rangy.rangePrototype.getStartOffset=function(c){if(c===!0)return this.startOffset;for(var c=0,b=this.startContainer,a=b.data.charCodeAt(0);a===
10||a===32;)c++,a=b.data.charCodeAt(c);return this.startOffset-c};rangy.rangePrototype.getNextTextNode=function(c){if(c.nodeType===ice.dom.ELEMENT_NODE&&c.childNodes.length!==0)return this.getFirstSelectableChild(c);c=this.getNextContainer(c);return c.nodeType===ice.dom.TEXT_NODE?c:this.getNextTextNode(c)};rangy.rangePrototype.getFirstSelectableChild=function(c){if(c)if(c.nodeType!==ice.dom.TEXT_NODE)for(c=c.firstChild;c;)if(this.isSelectable(c)===!0)return c;else if(c.firstChild){var b=this.getFirstSelectableChild(c);
if(b!==null)return b;else c=c.nextSibling}else c=c.nextSibling;else return c;return null};rangy.rangePrototype.getLastSelectableChild=function(c){if(c)if(c.nodeType!==ice.dom.TEXT_NODE)for(c=c.lastChild;c;)if(this.isSelectable(c)===!0)return c;else if(c.lastChild){var b=this.getLastSelectableChild(c);if(b!==null)return b;else c=c.previousSibling}else c=c.previousSibling;else return c;return null};rangy.rangePrototype.isSelectable=function(c){return c&&c.nodeType===ice.dom.TEXT_NODE&&c.data.length!==
0?!0:!1};rangy.rangePrototype.getHTMLContents=function(c){c||(c=this.cloneContents());var b=ice.env.document.createElement("div");b.appendChild(c.cloneNode(!0));return b.innerHTML};rangy.rangePrototype.getHTMLContentsObj=function(){return this.cloneContents()}})}).call(this);
(function(){var c=function(b){this._ice=b};c.prototype={start:function(){},clicked:function(){return!0},mouseDown:function(){return!0},keyDown:function(){return!0},keyPress:function(){return!0},selectionChanged:function(){},setEnabled:function(){},setDisabled:function(){},caretUpdated:function(){},nodeInserted:function(){},nodeCreated:function(){},caretPositioned:function(){},remove:function(){this._ice.removeKeyPressListener(this)},setSettings:function(){}};this.ice.IcePlugin=c}).call(this);
(function(){this.ice._plugin={};var c=function(b){this.plugins={};this.pluginConstructors={};this.keyPressListeners={};this.activePlugin=null;this.pluginSets={};this.activePluginSet=null;this._ice=b};c.prototype={getPluginNames:function(){var b=[],a;for(a in this.plugins)b.push(a);return b},addPluginObject:function(b,a){this.plugins[b]=a},addPlugin:function(b,a){if(typeof a!=="function")throw Error("IcePluginException: plugin must be a constructor function");ice.dom.isset(this.pluginConstructors[b])===
!1&&(this.pluginConstructors[b]=a)},loadPlugins:function(b,a){if(b.length===0)a.call(this);else{var c=b.shift();if(typeof c==="object")c=c.name;if(ice.dom.isset(ice._plugin[c])===!0)this.addPlugin(c,ice._plugin[c]),this.loadPlugins(b,a);else throw Error("plugin was not included in the page: "+c);}},_enableSet:function(b){this.activePluginSet=b;for(var a=this.pluginSets[b].length,c=0;c<a;c++){var e=this.pluginSets[b][c],f="",f=typeof e==="object"?e.name:e,g=this.pluginConstructors[f];g&&(g=new g(this._ice),
this.plugins[f]=g,ice.dom.isset(e.settings)===!0&&g.setSettings(e.settings),g.start())}},setActivePlugin:function(b){this.activePlugin=b},getActivePlugin:function(){return this.activePlugin},_getPluginName:function(b){b=b.toString();return b.substr(9,b.indexOf("(")-9)},removePlugin:function(b){this.plugins[b]&&this.plugins[b].remove()},getPlugin:function(b){return this.plugins[b]},usePlugins:function(b,a,c){var e=this;this.pluginSets[b]=ice.dom.isset(a)===!0?a:[];this.loadPlugins(this.pluginSets[b].concat([]),
function(){e._enableSet(b);c&&c.call(this)})},disablePlugin:function(b){this.plugins[b].disable()},isPluginElement:function(b){for(var a in this.plugins)if(this.plugins[a].isPluginElement&&this.plugins[a].isPluginElement(b)===!0)return!0;return!1},fireKeyPressed:function(b){if(this._fireKeyPressFns(b,"all_keys")===!1)return!1;var a=[];(b.ctrlKey===!0||b.metaKey===!0)&&a.push("ctrl");b.shiftKey===!0&&a.push("shift");b.altKey===!0&&a.push("alt");switch(b.keyCode){case 13:a.push("enter");break;case ice.dom.DOM_VK_LEFT:a.push("left");
break;case ice.dom.DOM_VK_RIGHT:a.push("right");break;case ice.dom.DOM_VK_UP:a.push("up");break;case ice.dom.DOM_VK_DOWN:a.push("down");break;case 9:a.push("tab");break;case ice.dom.DOM_VK_DELETE:a.push("delete");break;default:var c;if(b.keyCode)c=b.keyCode;else if(b.which)c=b.which;c&&a.push(String.fromCharCode(c).toLowerCase())}a=a.sort().join("+");return this._fireKeyPressFns(b,a)},_fireKeyPressFns:function(b,a){if(this.keyPressListeners[a])for(var c=this.keyPressListeners[a].length,e=0;e<c;e++){var f=
this.keyPressListeners[a][e],g=f.fn,h=f.plugin,f=f.data;if(g)if(ice.dom.isFn(g)===!0){if(g.call(h,b,f)===!0)return ice.dom.preventDefault(b),!1}else if(h[g]&&h[g].call(h,b,f)===!0)return ice.dom.preventDefault(b),!1}return!0},fireSelectionChanged:function(b){for(var a in this.plugins)this.plugins[a].selectionChanged(b)},fireNodeInserted:function(b,a){for(var c in this.plugins)if(this.plugins[c].nodeInserted(b,a)===!1)return!1},fireNodeCreated:function(b){for(var a in this.plugins)if(this.plugins[a].nodeCreated(b)===
!1)return!1},fireCaretPositioned:function(){for(var b in this.plugins)this.plugins[b].caretPositioned()},fireClicked:function(b){var a=!0,c;for(c in this.plugins)this.plugins[c].clicked(b)===!1&&(a=!1);return a},fireMouseDown:function(b){var a=!0,c;for(c in this.plugins)this.plugins[c].mouseDown(b)===!1&&(a=!1);return a},fireKeyDown:function(b){var a=!0,c;for(c in this.plugins)this.plugins[c].keyDown(b)===!1&&(a=!1);return a},fireKeyPress:function(b){var a=!0,c;for(c in this.plugins)this.plugins[c].keyPress(b)===
!1&&(a=!1);return a},fireEnabled:function(b){for(var a in this.plugins)this.plugins[a].setEnabled(b)},fireDisabled:function(b){for(var a in this.plugins)this.plugins[a].setDisabled(b)},fireCaretUpdated:function(){for(var b in this.plugins)this.plugins[b].caretUpdated&&this.plugins[b].caretUpdated()}};this.ice.IcePluginManager=c}).call(this);
(function(){var c=this.ice,b;b=function(a){this._ice=a};b.prototype={nodeCreated:function(a){a.setAttribute("title","Modified by "+a.getAttribute(this._ice.userNameAttribute)+" - "+c.dom.date("m/d/Y h:ia",parseInt(a.getAttribute(this._ice.timeAttribute))))}};c.dom.noInclusionInherits(b,c.IcePlugin);this.ice._plugin.IceAddTitlePlugin=b}).call(this);
(function(){var c=this.ice,b;b=function(a){this._ice=a;this._tmpNode=null;this._tmpNodeTagName="icepaste";var b=this;this.pasteType="formattedClean";this.preserve="p";this.beforePasteClean=function(a){return a};this.afterPasteClean=function(a){return a};a.element.oncopy=function(){return b.handleCopy.apply(b)};a.element.oncut=function(){return b.handleCut.apply(b)};a.element.onpaste=function(){return b.handlePaste.apply(b)}};b.prototype={setSettings:function(a){a=a||{};c.dom.extend(this,a);this.preserve+=
","+this._tmpNodeTagName;this.setupPreserved()},handleCut:function(){if(this._ice.isTracking){var a=this._ice.getCurrentRange();if(!a.collapsed){var b=a.cloneContents(),c=this;setTimeout(function(){c.doCut(b)},1);return!0}}},doCut:function(a){var b=this._ice.getCurrentRange(),e,f;this._tmpNode=c.env.document.createElement("span");b.insertNode(this._tmpNode);b.setStartAfter(this._tmpNode);for(b.collapse(!0);e=a.firstChild;)b.insertNode(e),b.setStartAfter(e),b.collapse(!0),f=e;b.setStartBefore(this._tmpNode);
b.collapse(!0);b.setEndAfter(f);c.env.selection.addRange(b);this._ice.deleteContents();c.dom.remove(this._tmpNode)},handleCopy:function(){},handlePaste:function(){var a=this._ice.getCurrentRange();a.collapsed||(this._ice.isTracking?(this._ice.deleteContents(),a=a.cloneRange()):(a.deleteContents(),a.collapse(!0)));this._ice.isTracking&&this._ice._moveRangeToValidTrackingPos(a);if(a.startContainer==this._ice.element){var b=c.dom.find(this._ice.element,this._ice.blockEl)[0];b||(b=c.dom.create("<"+this._ice.blockEl+
" ><br/></"+this._ice.blockEl+">"),this._ice.element.appendChild(b));a.setStart(b,0);a.collapse(!0);c.env.selection.addRange(a)}this._tmpNode=c.env.document.createElement(this._tmpNodeTagName);a.insertNode(this._tmpNode);a=c.dom.extractContent(this._ice.element);b=c.env.selection.createRange();b.selectNodeContents(this._ice.element);c.env.selection.addRange(b);switch(this.pasteType){case "formatted":this.handleFormattedPaste(a);break;case "formattedClean":this.handleFormattedPaste(a,!0)}return!0},
handleFormattedPaste:function(a,b){var c=this;window.setTimeout(function(){c.handleFormattedPasteValue(a,b)},1);return!0},handleFormattedPasteValue:function(a,b){var e=this.beforePasteClean(this._ice.element.innerHTML),f=c.dom.children("<div>"+e+"</div>",this._ice.blockEl);f.length===1&&c.dom.getNodeTextContent("<div>"+e+"</div>")===c.dom.getNodeTextContent(f)&&(e=c.dom.getHtml(e));b&&(e=this._ice.getCleanContent(e),e=this.stripPaste(e));e=this.afterPasteClean.call(this,e);e=c.dom.trim(e);this._ice.element.innerHTML=
"";this._ice.element.appendChild(a);var g=this._ice.getCurrentRange();g.setStartAfter(this._tmpNode);g.collapse(!0);var h=null,e=g.createContextualFragment(e),f=this._ice.startBatchChange(this._ice.changeTypes.insertType.alias);if(c.dom.hasBlockChildren(e)){var j=c.dom.isChildOfTagName(this._tmpNode,this._ice.blockEl);g.setEndAfter(j.lastChild);this._ice.selection.addRange(g);var h=g.extractContents(),n=c.env.document.createElement(this._ice.blockEl);n.appendChild(h);c.dom.insertAfter(j,n);g.setStart(n,
0);g.collapse(!0);this._ice.selection.addRange(g);for(var g=g.startContainer,l=null,j=null;e.firstChild;)if(e.firstChild.nodeType===3&&!jQuery.trim(e.firstChild.nodeValue))e.removeChild(e.firstChild);else if(c.dom.isBlockElement(e.firstChild)){if(e.firstChild.textContent!=="")j=l=null,this._ice.isTracking?(j=this._ice.createIceNode("insertType"),this._ice.addChange("insertType",[j]),h=document.createElement(e.firstChild.tagName),j.innerHTML=e.firstChild.innerHTML,h.appendChild(j)):(j=h=document.createElement(e.firstChild.tagName),
h.innerHTML=e.firstChild.innerHTML),c.dom.insertBefore(g,h);e.removeChild(e.firstChild)}else l||(h=document.createElement(this._ice.blockEl),c.dom.insertBefore(g,h),this._ice.isTracking?(l=this._ice.createIceNode("insertType"),this._ice.addChange("insertType",[l]),h.appendChild(l)):l=h),j=l,l.appendChild(e.removeChild(e.firstChild));n.textContent||n.parentNode.removeChild(n)}else if(this._ice.isTracking)h=this._ice.createIceNode("insertType",e),this._ice.addChange("insertType",[h]),g.insertNode(h),
j=h;else for(;n=e.firstChild;)g.insertNode(n),g.setStartAfter(n),g.collapse(!0),j=n;this._ice.endBatchChange(f);this._cleanup(j)},createDiv:function(a){var b=c.dom.getId(a);if(b)return c.dom.empty(b),b;b=c.env.document.createElement("div");b.id=a;b.setAttribute("contentEditable",!0);c.dom.setStyle(b,"width","0px");c.dom.setStyle(b,"height","0px");c.dom.setStyle(b,"overflow","hidden");c.dom.setStyle(b,"position","fixed");c.dom.setStyle(b,"top","10px");c.dom.setStyle(b,"left","10px");document.body.appendChild(b);
return b},handleCut:function(){this.cutElementId="icecut";this.cutElement=this.createDiv(this.cutElementId);var a=this._ice.getCurrentRange();if(!a.collapsed){var b=a.getHTMLContents();this._ice.isTracking?this._ice.deleteContents():a.deleteContents();var e=a.cloneRange();e.collapse(!0);this.cutElement.innerHTML=b;a.setStart(this.cutElement.firstChild,0);a.setEndAfter(this.cutElement.lastChild,this.cutElement.lastChild.length);setTimeout(function(){a.setStart(e.startContainer,e.startOffset);a.collapse(!0);
c.env.selection.addRange(a);c.dom.remove(this.cutElement)},10)}},stripPaste:function(a){a=this._cleanWordPaste(a);return a=this.cleanPreserved(a)},setupPreserved:function(){var a=this;this._tags="";this._attributesMap=[];c.dom.each(this.preserve.split(","),function(b,c){c.match(/(\w+)(\[(.+)\])?/);var f=RegExp.$1,g=RegExp.$3;a._tags&&(a._tags+=",");a._tags+=f.toLowerCase();a._attributesMap[f]=g.split("|")})},cleanPreserved:function(a){var b=this,e=c.env.document.createElement("div");e.innerHTML=a;
e=c.dom.stripEnclosingTags(e,this._tags);c.dom.each(c.dom.find(e,this._tags),function(a,e){var h=e.tagName.toLowerCase(),h=b._attributesMap[h];if(h[0]&&h[0]==="*")return!0;if(e.hasAttributes())for(var j=e.attributes,a=j.length-1;a>=0;a--)c.dom.inArray(j[a].name,h)||e.removeAttribute(j[a].name)});return e.innerHTML},_cleanWordPaste:function(a){a=a.replace(/<(meta|link)[^>]+>/g,"");a=a.replace(/<\!--(.|\s)*?--\>/g,"");a=a.replace(/<style>[\s\S]*?<\/style>/g,"");a=a.replace(/<\/?\w+:[^>]*>/gi,"");a=
a.replace(/<\\?\?xml[^>]*>/gi,"");a=this._cleanPaste(a);a=this._convertWordPasteList(a);a=a.replace(/<(\w[^>]*) (lang)=([^ |>]*)([^>]*)/gi,"<$1$4");return a=a.replace(RegExp('<(\\w[^>]*) style="([^"]*)"([^>]*)',"gi"),"<$1$3")},_getListType:function(a,b){var e=c.dom.getHtml(a),f=null;c.dom.foreach(b,function(a){c.dom.foreach(b[a],function(h){c.dom.foreach(b[a][h],function(c){if(RegExp(b[a][h][c]).test(e)===!0)return f={html:e.replace(RegExp(b[a][h][c]),""),listType:a,listStyle:h},!1});if(f!==null)return!1});
if(f!==null)return!1});return f},_convertWordPasteList:function(a){var b=document.createElement("div"),e=null,f=null,g={},h=null,j=!0,n={ul:{circle:["^o(s|&nbsp;)+"],disc:["^"+String.fromCharCode(183)+"(\\s|&nbsp;)+"],square:["^"+String.fromCharCode(167)+"(\\s|&nbsp;)+"],auto:["^"+String.fromCharCode(8226)+"(\\s|&nbsp;)+"]},ol:{decimal:["^\\d+\\.(s|&nbsp;)+"],"lower-roman":["^[ivxlcdm]+\\.(\\s|&nbsp;)+"],"upper-roman":["^[IVXLCDM]+\\.(\\s|&nbsp;)+"],"lower-alpha":["^[a-z]+\\.(\\s|&nbsp;)+"],"upper-alpha":["^[A-Z]+\\.(\\s|&nbsp;)+"]}};
c.dom.setHtml(b,a);for(var a=c.dom.getTag("p",b),l=a.length,s=0;s<l;s++){var o=a[s],i=this._getListType(o,n);if(i!==null){var q=parseInt(c.dom.getStyle(o,"margin-left")),k=i.listType,p=i.listStyle;c.dom.setHtml(o,i.html);k||(k="ol");j?(e=document.createElement(k),g={},c.dom.attr(e,"_icelistst","list-style-type:"+p),g[q]=e,c.dom.insertBefore(o,e)):q!==f&&(c.dom.isset(g[q])===!0?e=g[q]:q>f&&(e=document.createElement(k),c.dom.attr(e,"_icelistst","list-style-type:"+p),h.appendChild(e),g[q]=e));h=this._createListItemFromElement(o);
e.appendChild(h);f=q;c.dom.remove(o);j=!1}else j=!0}return a=c.dom.getHtml(b)},_createListItemFromElement:function(a){for(var b=document.createElement("li");a.firstChild;)b.appendChild(a.firstChild);return b},_cleanPaste:function(a){a=a.replace(/<b(\s+|>)/g,"<strong$1");a=a.replace(/<\/b(\s+|>)/g,"</strong$1");a=a.replace(/<i(\s+|>)/g,"<em$1");return a=a.replace(/<\/i(\s+|>)/g,"</em$1")},_cleanup:function(a){try{var a=a&&a.lastChild||a||this._tmpNode,b=this._ice.getCurrentRange();b.setStart(a,a.length);
b.collapse(!0);this._ice.selection.addRange(b);c.env.frame?c.env.frame.contentWindow.focus():this._ice.element.focus();this._tmpNode.parentNode.removeChild(this._tmpNode);this._tmpNode=null;for(var e=c.env.document.getElementsByClassName(this._ice.changeTypes.insertType.alias),a=0;a<e.length;a++)e[a].textContent||e[a].parentNode&&e[a].parentNode.removeChild(e[a])}catch(f){window.console&&console.error(f)}}};c.dom.noInclusionInherits(b,c.IcePlugin);this.ice._plugin.IceCopyPastePlugin=b}).call(this);
(function(){var c=this.ice,b=function(a){this._ice=a};b.prototype={convert:function(a){var b=this;c.dom.each(a.getElementsByTagName(this.ice.blockEl),function(a,c){try{b.ice.placeholdDeletes(),b._convertBlock(c)}catch(g){console.error(g)}finally{b.ice.revertDeletePlaceholders()}})},_convertBlock:function(a){if(!(a.textContent.length<2)){var b=String.fromCharCode(8216),c=String.fromCharCode(8217),f=String.fromCharCode(8220),g=String.fromCharCode(8221),h=function(a){return a===String.fromCharCode(160)||
a===String.fromCharCode(32)},j=this.ice.selection.createRange(),n=a.cloneNode(!0);j.setStart(n,0);j.collapse(!0);for(var n=[],l=null,s=null,o=null,i=0;;)try{j.moveEnd("character",1),n.push(j.cloneContents().textContent.charAt(i++))}catch(q){break}for(i=0;i<=n.length;i++)switch(l=s,s=o,o=n.length===i?null:n[i],s){case b:case c:this.replaceCharAtPosition("'",i,a);case "'":(l===null||h(l))&&/\d/.test(o)&&/\d/.test(n[i+1])&&h(n[i+2])?this.replaceCharAtPosition(c,i,a):l===null||h(l)&&!h(o)?this.replaceCharAtPosition(b,
i,a):o===null||!h(l)&&h(o)?this.replaceCharAtPosition(c,i,a):/\w/.test(l)&&/\w/.test(o)&&this.replaceCharAtPosition(c,i,a);break;case f:case g:this.replaceCharAtPosition('"',i,a);case '"':l===null||h(l)&&!h(o)?this.replaceCharAtPosition(f,i,a):o===null||!h(l)&&h(o)?this.replaceCharAtPosition(g,i,a):(l===null||h(l))&&h(o)&&(n[i+1]==="'"||n[i+1]===b||n[i+1]===c)?this.replaceCharAtPosition(f,i,a):(o===null||h(o))&&h(l)&&(n[i-3]==="'"||n[i-3]===b||n[i-3]===c)&&this.replaceCharAtPosition(g,i,a)}}},replaceCharAtPosition:function(a,
b,c){var f=this.ice.selection.createRange();for(f.setStart(c,0);b-- >1;)f.moveStart("character",1);try{f.moveStart("character",1),f.moveStart("character",-1)}catch(g){}f.collapse(!0);f.moveEnd("character",1);f.extractContents();this.ice.insert(a,f)}};c.dom.noInclusionInherits(b,c.IcePlugin);this.ice._plugin.IceSmartQuotesPlugin=b}).call(this);
(function(){var c=this.ice,b=function(a){this._ice=a};b.prototype={keyDown:function(a){if(c.dom.isBrowser("mozilla")){if(a.keyCode===109)return this.convertEmdash(a)}else if(a.keyCode===189)return this.convertEmdash(a);return!0},convertEmdash:function(){var a=this._ice.getCurrentRange();if(a.collapsed){try{a.moveStart(c.dom.CHARACTER_UNIT,-1);var b=c.dom.getParents(a.startContainer,this._ice.blockEl)[0],e=c.dom.getParents(a.endContainer,this._ice.blockEl)[0];if(b===e&&!this._ice.getIceNode(a.startContainer,
"deleteType")){var f=a.cloneContents();if(c.dom.getNodeTextContent(f)==="-")return a.extractContents(),a.collapse(),this._ice.insert(c.env.document.createTextNode("\u2014"),a),a=this._ice.getCurrentRange(),a.moveStart(c.dom.CHARACTER_UNIT,1),a.collapse(!0),c.env.selection.addRange(a),!1}}catch(g){}a.collapse()}return!0}};c.dom.noInclusionInherits(b,c.IcePlugin);this.ice._plugin.IceEmdashPlugin=b}).call(this);
